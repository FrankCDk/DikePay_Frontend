@using MudBlazor
@inject IJSRuntime JS
@inject IMudDialogInstance MudDialog

<MudDialog>
    <DialogContent>
        <div id="reader" style="width: 100%; min-height: 300px; background: #000; border-radius: 8px; overflow: hidden;"></div>
        <MudText Align="Align.Center" Class="mt-2">Coloque el código frente a la cámara</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cerrar" Color="Color.Error">Cancelar</MudButton>
    </DialogActions>
</MudDialog>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // El delay es para asegurar que el ID "reader" ya existe en el DOM
            await Task.Delay(500);
            try
            {
                await JS.InvokeVoidAsync("startScanner", DotNetObjectReference.Create(this));
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error iniciando scanner: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public void OnBarcodeDetected(string code)
    {
        // Cerramos devolviendo el código al componente padre (Venta.razor)
        MudDialog.Close(DialogResult.Ok(code));
    }

    private async Task Cerrar()
    {
        await JS.InvokeVoidAsync("stopScanner");
        MudDialog.Cancel();
    }
}