@using BarcodeStandard
@using SkiaSharp
@using MudBlazor

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Código de Barras</MudText>
    </TitleContent>
    <DialogContent>
        <div class="d-flex flex-column align-center">
            @if (!string.IsNullOrEmpty(_barcodeBase64))
            {
                <MudPaper Class="pa-4 mt-2" Elevation="0" Style="background-color: white;">
                    @* Renderizamos el código como una imagen HTML estándar *@
                    <img src="data:image/png;base64,@_barcodeBase64"
                         style="width: 300px; height: 150px; display: block;"
                         alt="Código de Barras" />
                </MudPaper>

                <MudText Align="Align.Center" Class="mt-4" Typo="Typo.h5" Style="font-family: monospace;">
                    @CodigoSku
                </MudText>
                <MudText Align="Align.Center" Typo="Typo.caption" Color="Color.Secondary">
                    Este código es único para este artículo.
                </MudText>
            }
            else
            {
                <MudAlert Severity="Severity.Error" Variant="Variant.Filled">
                    No se pudo generar el código de barras.
                </MudAlert>
            }
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="Cancel">Cerrar</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public string CodigoSku { get; set; } = string.Empty;

    private string? _barcodeBase64;

    protected override void OnInitialized()
    {
        GenerarBarcode();
    }

    private void GenerarBarcode()
    {
        if (string.IsNullOrEmpty(CodigoSku)) return;

        try
        {
            // 1. Configuramos el generador
            var b = new BarcodeStandard.Barcode();
            b.IncludeLabel = false; // El texto lo ponemos nosotros con MudText para que se vea mejor

            // 2. Generamos el SKImage (300x150 es un estándar cómodo)
            using var img = b.Encode(BarcodeStandard.Type.Code128, CodigoSku, SKColors.Black, SKColors.White, 300, 150);

            // 3. Convertimos el SKImage a bytes en formato PNG
            using var data = img.Encode(SKEncodedImageFormat.Png, 100);

            // 4. Transformamos a Base64 para que el navegador lo entienda
            byte[] byteData = data.ToArray();
            _barcodeBase64 = Convert.ToBase64String(byteData);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error generando barcode: {ex.Message}");
            _barcodeBase64 = null;
        }
    }

    void Cancel() => MudDialog.Cancel();
}