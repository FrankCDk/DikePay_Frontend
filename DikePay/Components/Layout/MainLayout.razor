@inherits LayoutComponentBase
@using DikePay.Domain.Entities
@using DikePay.Application.Interfaces.Services
@using DikePay.Application.Interfaces
@using DikePay.Shared.State
@using Microsoft.Maui.Devices
@inject NavigationManager Navigation
@inject ISyncService SyncService
@inject IAuthService AuthService
@inject ISyncWorkerService SyncWorker
@inject INetworkService ConnectivityService
@inject INotificationService NotifService
@implements IDisposable
@inject AppState AppStateInstance
@inject MudBlazor.ISnackbar SnackbarService

<MudThemeProvider Theme="_dikePayTheme" @bind-IsDarkMode="@_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<style>
    :root {
        /* Aumentamos el margen de seguridad superior para evitar solapamientos */
        --safe-area-top: var(--maui-safe-area-inset-top, 40px); 
        --safe-area-bottom: var(--maui-safe-area-inset-bottom, 24px);
    }

    .is-mobile .status-bar-safe-area {
        height: var(--safe-area-top);
        background-color: var(--mud-palette-appbar-background);
        width: 100%;
        position: fixed;
        top: 0;
        z-index: 100; /* Bajado de 1400 a 100 */
        display: block;
    }

    .is-mobile .mud-appbar-fixed-top {
        top: var(--safe-area-top) !important;
    }

    /* Evita que el contenido de las páginas se meta debajo de la barra azul */
    .is-mobile .mud-main-content {
        padding-top: calc(var(--mud-appbar-height) + var(--safe-area-top) + 16px) !important;
        padding-bottom: 100px !important; /* Espacio para el nuevo menú inferior */
    }

    /* Estilo para que el menú inferior se vea como el de Global66 */
    .bottom-nav-premium {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: calc(75px + var(--safe-area-bottom));
        background: white;
        display: flex;
        justify-content: space-around;
        align-items: flex-start;
        padding-top: 12px;
        border-top: 1px solid #EEE;
        z-index: 100; /* Bajado de 1400 a 100 */
    }

    .nav-item-custom {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: #94A3B8;
        text-decoration: none;
        width: 20%; 
        background: none;
        border: none;
    }

    .nav-item-custom.active {
        color: #1E3A8A; /* Tu azul primario */
    }

    .nav-item-custom span {
        font-size: 11px;
        font-weight: 500;
        margin-top: 4px;
    }

    /* Estilo para el Botón Circular de Venta */
    .nav-item-central {
        position: relative;
        top: -25px; /* Lo sube para que sobresalga de la barra */
        width: 20%;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: none;
        border: none;
    }

    .sale-fab {
        background-color: #1E3A8A; /* Tu azul primario */
        color: white;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(30, 58, 138, 0.4);        
        transition: transform 0.2s;
    }

    .sale-fab:active {
        transform: scale(0.9);
    }

</style>

<MudLayout Class="@_layoutClass">

    @if (_isMobile)
    {
        <div class="status-bar-safe-area"></div>
    }

    @* Barra Superior *@
    <MudAppBar Elevation="1" Color="Color.Primary">

        @if (!_isMobile)
        {
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        }

        <MudText Typo="Typo.h6" Class="ml-3">DikePay</MudText>
        <MudSpacer />
        <MudToggleIconButton @bind-Toggled="@_isDarkMode"
                             Icon="@Icons.Material.Filled.DarkMode" Color="Color.Inherit"
                             ToggledIcon="@Icons.Material.Filled.LightMode" ToggledColor="Color.Inherit"
                             Title="Cambiar modo" />

        <MudBadge Dot="true" Color="@(AppStateInstance.IsOnline? Color.Success: Color.Error)" Class="mx-2"> 
            <MudIcon Icon="@Icons.Material.Outlined.Wifi" /> 
        </MudBadge>

        @* Notificaciones *@
        <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" ActivationEvent="MouseEvent.LeftClick" PopoverClass="mud-popover-cascading">
            <ActivatorContent>
                @* Dinamizamos el Content y la Visibilidad *@
                <MudBadge Content="@NotifService.NoLeidas" Color="Color.Error" Overlap="true" Class="mx-3" Visible="@(NotifService.NoLeidas > 0)">
                    <MudIconButton Icon="@Icons.Material.Outlined.Notifications" Color="Color.Inherit" />
                </MudBadge>
            </ActivatorContent>
            <ChildContent>
                <MudCard Elevation="0" Style="width: 350px; max-height: 450px; overflow-y: auto;">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Notificaciones</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            @* Acción para marcar como leído *@
                            <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small" OnClick="NotifService.MarcarComoLeidas">
                                Marcar todo como leído
                            </MudButton>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudDivider />
            
                    @if (NotifService.Notificaciones.Any())
                    {
                        <MudList T="string">
                            @foreach (var notif in NotifService.Notificaciones)
                            {
                                <MudListItem Icon="@(notif.Tipo == TipoNotificacion.Error ? Icons.Material.Filled.Error : Icons.Material.Filled.Info)"
                                             IconColor="@(notif.Tipo == TipoNotificacion.Error ? Color.Error : Color.Info)">
                                    <div class="d-flex flex-column">
                                        <MudText Typo="Typo.body2" Style="font-weight: bold;">@notif.Titulo</MudText>
                                        <MudText Typo="Typo.caption">@notif.Mensaje</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@notif.Fecha.ToShortTimeString()</MudText>
                                    </div>
                                </MudListItem>
                                <MudDivider />
                            }
                        </MudList>
                    }
                    else
                    {
                        <div class="pa-8 d-flex flex-column align-center justify-center">
                            <MudIcon Icon="@Icons.Material.Outlined.NotificationsOff" Color="Color.Default" Style="font-size: 3rem;" />
                            <MudText Typo="Typo.body2" Class="mt-2" Color="Color.Secondary">No tienes notificaciones nuevas</MudText>
                        </div>
                    }
                </MudCard>
            </ChildContent>
        </MudMenu>

        @* Menú de Usuario *@
        <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" ActivationEvent="MouseEvent.LeftClick" PopoverClass="mud-popover-cascading">
            <ActivatorContent>
                @* <MudAvatar Color="Color.Secondary">FC</MudAvatar> *@
                <MudAvatar Color="Color.Secondary">@ObtenerIniciales()</MudAvatar>
            </ActivatorContent>
            <ChildContent>
                <div class="pa-4 d-flex flex-column align-center" style="min-width: 200px;">
                    <MudAvatar Color="Color.Secondary" Style="height:60px; width:60px;">@ObtenerIniciales()</MudAvatar>
                    <MudText Typo="Typo.body1" Class="mt-2" Style="font-weight: bold;">@UsuarioNombre</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">@UsuarioEmail</MudText>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Text" Class="mt-1">@UsuarioRol</MudChip>
                </div>
                <MudDivider />
                <MudMenuItem Icon="@Icons.Material.Outlined.Person" Href="/configuracion/acceso">Mi Perfil</MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Outlined.Security">Seguridad</MudMenuItem>
                <MudDivider />
                <MudMenuItem Icon="@Icons.Material.Outlined.Logout" Color="Color.Error" OnClick="CerrarSesion">Cerrar Sesión</MudMenuItem>
            </ChildContent>
        </MudMenu>
    </MudAppBar>

    @* Menú Lateral (Drawer) *@
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2" Variant="@DrawerVariant.Responsive">
        <NavMenu />
    </MudDrawer>

    @* Contenido Principal *@
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="my-6">
            @Body
        </MudContainer>

        @* Espacio extra al final para que la barra no tape el contenido en móvil *@
        @if (_isMobile)
        {
            <div style="height: 65px;"></div>
        }
    </MudMainContent>

    @* BARRA DE NAVEGACIÓN INFERIOR PARA MÓVILES *@
    @if (_isMobile)
{
    <div class="bottom-nav-premium">
        @* 1. Inicio *@
        <button class="nav-item-custom @(GetActiveClass("/Inicio"))" @onclick="@(() => Navigation.NavigateTo("/Inicio"))">
            <MudIcon Icon="@Icons.Material.Filled.Home" Size="Size.Medium" />
            <span>Inicio</span>
        </button>

        @* 2. Inventario *@
        <button class="nav-item-custom @(GetActiveClass("/inventario"))" @onclick="@(() => Navigation.NavigateTo("/inventario"))">
            <MudIcon Icon="@Icons.Material.Filled.Inventory2" Size="Size.Medium" />
            <span>Stock</span>
        </button>

        @* 3. BOTÓN CENTRAL: NUEVA VENTA *@
        <button class="nav-item-central" @onclick="@(() => Navigation.NavigateTo("/facturacion/dashboard"))">
            <div class="sale-fab">
                <MudIcon Icon="@Icons.Material.Filled.AddShoppingCart" Size="Size.Large" />
            </div>
        </button>

        @* 4. Historial/Comandas (u otra opción) *@
        <button class="nav-item-custom @(GetActiveClass("/comanda"))" @onclick="@(() => Navigation.NavigateTo("/comanda"))">
            <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Medium" />
            <span>Comandas</span>
        </button>

        @* 5. Ajustes *@
        <button class="nav-item-custom @(GetActiveClass("/configuracion"))" @onclick="@(() => Navigation.NavigateTo("/configuracion/articulos"))">
            <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Medium" />
            <span>Ajustes</span>
        </button>
    </div>
}
    
</MudLayout>

@code {

    [Inject] private ISnackbar Snackbar { get; set; }
    bool _drawerOpen = true;
    private bool _isMobile;
    private string _layoutClass = "";
    private bool _isDarkMode;

    private string UsuarioNombre => AppStateInstance.UsuarioActivo?.NombreCompleto ?? "Usuario";
    private string UsuarioEmail => AppStateInstance.UsuarioActivo?.Email ?? "Sin correo";
    private string UsuarioRol => AppStateInstance.UsuarioActivo?.Rol ?? "Invitado";

    // Generar iniciales para el Avatar (ej: "Frank Casuso" -> "FC")
    private string ObtenerIniciales()
    {
        if (string.IsNullOrWhiteSpace(UsuarioNombre)) return "??";
        var palabras = UsuarioNombre.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (palabras.Length == 1) return palabras[0][0].ToString().ToUpper();
        return (palabras[0][0].ToString() + palabras[1][0].ToString()).ToUpper();
    }

    protected override void OnInitialized()
    {

        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
        Snackbar.Configuration.PreventDuplicates = true;
        Snackbar.Configuration.NewestOnTop = true;
        Snackbar.Configuration.VisibleStateDuration = 1000; // Aquí lo dejas fijo


        // Detectamos si es móvil una sola vez al iniciar
        _isMobile = DeviceInfo.Current.Platform != DevicePlatform.WinUI &&
                    DeviceInfo.Current.Platform != DevicePlatform.MacCatalyst;

        // Si es móvil, aplicamos la clase que activa el CSS especial
        _layoutClass = _isMobile ? "is-mobile" : "";
        _isDarkMode = AppInfo.RequestedTheme == AppTheme.Dark;

        AppStateInstance.OnChange += HandleStateChanged;

        // Suscripciones al SYNC
        SyncService.OnSyncStarted += HandleSyncStarted;
        SyncService.OnSyncCompleted += HandleSyncSuccess; // Suscripción al éxito de la sincronización
        SyncService.OnSyncError += HandleSyncError;

        // 1. Suscripción al cambio de notificaciones
        NotifService.OnChange += HandleNotifStateChanged;

        AppStateInstance.SetConnectivity(ConnectivityService.HasInternet); 
        ConnectivityService.ConnectivityChanged += HandleConnectivityChanged;

        _ = Task.Run(async () =>
                {
                    try
                    {
                        await SyncService.SincronizarTodoAsync();
                    }
                    catch (Exception) { /* Loguear error de sync silencioso */ }
                });
        
    }

    private void HandleSyncStarted() 
    {
        InvokeAsync(StateHasChanged);
    }

    private void HandleNotifStateChanged() 
    {
        InvokeAsync(StateHasChanged);
    }

    private void HandleStateChanged() => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        AppStateInstance.OnChange -= HandleStateChanged;
        ConnectivityService.ConnectivityChanged -= HandleConnectivityChanged;
        // ¡No olvides desuscribirte para evitar fugas de memoria!
        SyncService.OnSyncStarted -= HandleSyncStarted;
        SyncService.OnSyncCompleted -= HandleSyncSuccess;
        SyncService.OnSyncError -= HandleSyncError;
        NotifService.OnChange -= HandleNotifStateChanged;
    }

    private void HandleConnectivityChanged(bool isConnected) { 
        InvokeAsync(() => { 
            AppStateInstance.SetConnectivity(isConnected); 
            SnackbarService.Add(
                isConnected ? "Conectado a Internet" : "Sin conexión a Internet", 
                isConnected ? Severity.Success : Severity.Warning, 
                config => { config.VisibleStateDuration = 4000; }); 
                StateHasChanged(); 
        }); 
    }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }
   
    private MudTheme _dikePayTheme = new MudTheme()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#1E3A8A",          // Azul Marino (Confianza y Seriedad)
            Secondary = "#B45309",        // Ámbar/Dorado (Ventas y Éxito)
            AppbarBackground = "#1E3A8A",
            AppbarText = "#FFFFFF",
            Background = "#F8FAFC",       // Gris azulado muy claro (Descansa la vista)
            Surface = "#FFFFFF",
            DrawerBackground = "#FFFFFF",
            DrawerText = "#1E293B",
            Success = "#10B981",          // Verde Esmeralda para ventas cerradas
            Info = "#3B82F6",
            Warning = "#F59E0B",
            Error = "#EF4444",
            LinesDefault = "#E2E8F0",     // Bordes más suaves
            TableStriped = "#F1F5F9"
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#3B82F6",          // Azul más brillante para modo oscuro
            Secondary = "#F59E0B",
            AppbarBackground = "#0F172A", // Azul oscuro casi negro
            Background = "#020617",       // Fondo profundo
            Surface = "#0F172A",          // Tarjetas elevadas
            DrawerBackground = "#0F172A",
            TextPrimary = "#F1F5F9",
            TextSecondary = "#94A3B8",
            ActionDefault = "#64748B"
        },
        LayoutProperties = new LayoutProperties()
        {
            DefaultBorderRadius = "12px",    // Menos redondeado para verse más corporativo
        },
    };

    private string GetActiveClass(string page)
    {
        var relativePath = "/" + Navigation.ToBaseRelativePath(Navigation.Uri).ToLower();
        // Si estamos en la raíz o la ruta coincide
        if (page == "/Inicio" && relativePath == "/") return "active";
        return relativePath.StartsWith(page.ToLower()) ? "active" : "";
    }


    private async Task CerrarSesion(){

        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/");

    }

    private void HandleSyncSuccess(string mensaje)
    {
        // IMPORTANTE: El evento viene de un hilo de fondo del Task.Run
        // Debemos regresar al hilo de la UI para mostrar el Snackbar
        InvokeAsync(() =>
        {
            SnackbarService.Add(mensaje, Severity.Success, config =>
            {
                config.VisibleStateDuration = 5000;
                config.HideTransitionDuration = 500;
            });
            StateHasChanged();
        });
    }

    private void HandleSyncError(string mensaje)
    {
        InvokeAsync(() =>
        {
            SnackbarService.Add(mensaje, Severity.Error, config =>
            {
                config.VisibleStateDuration = 7000; // Un poco más de tiempo para errores
                config.DuplicatesBehavior = SnackbarDuplicatesBehavior.Prevent; // No llenar la pantalla de errores iguales
            });
            StateHasChanged();
        });
    }
}