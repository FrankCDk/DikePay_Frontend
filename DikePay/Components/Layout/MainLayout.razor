@inherits LayoutComponentBase
@using DikePay.Application.Interfaces.Services
@using DikePay.Shared.State
@using Microsoft.Maui.Devices
@inject NavigationManager Navigation
@inject ISyncService SyncService
@inject IAuthService AuthService
@inject ISyncWorkerService SyncWorker
@implements IDisposable
@inject AppState AppStateInstance
@inject MudBlazor.ISnackbar SnackbarService

<MudThemeProvider Theme="_dikePayTheme" @bind-IsDarkMode="@_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<style>
    :root {
        --safe-area-top: var(--maui-safe-area-inset-top, 32px);
    }

    /* Estos estilos SOLO afectarán si el contenedor tiene la clase 'is-mobile' */
    /* .is-mobile .status-bar-safe-area {
        height: var(--safe-area-top);
        background-color: #594AE2;
        width: 100%;
        position: fixed;
        top: 0;
        z-index: 1400;
        display: block;
    } */

    .is-mobile .status-bar-safe-area {
        height: var(--safe-area-top);
        background-color: var(--mud-palette-appbar-background);
        width: 100%;
        position: fixed;
        top: 0;
        z-index: 1400;
        display: block;
    }

    .is-mobile .mud-appbar-fixed-top {
        top: var(--safe-area-top) !important;
    }

    .is-mobile .mud-main-content {
        padding-top: calc(var(--mud-appbar-height) + var(--safe-area-top) + 8px) !important;
    }

    .is-mobile .mud-drawer {
        margin-top: var(--safe-area-top) !important;
        height: calc(100% - var(--safe-area-top)) !important;
    }
</style>


@if (SyncService.EstaSincronizando)
{
    <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Dense="true" Class="mb-4">
        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
        Actualizando catálogo de productos...
    </MudAlert>
}

<MudLayout Class="@_layoutClass">

    @if (_isMobile)
    {
        <div class="status-bar-safe-area"></div>
    }

    @* Barra Superior *@
    <MudAppBar Elevation="1" Color="Color.Primary">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <MudText Typo="Typo.h6" Class="ml-3">DikePay</MudText>
        <MudSpacer />
        <MudToggleIconButton @bind-Toggled="@_isDarkMode"
                             Icon="@Icons.Material.Filled.DarkMode" Color="Color.Inherit"
                             ToggledIcon="@Icons.Material.Filled.LightMode" ToggledColor="Color.Inherit"
                             Title="Cambiar modo" />

        @* Notificaciones *@
        <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" ActivationEvent="MouseEvent.LeftClick" PopoverClass="mud-popover-cascading"  >
            <ActivatorContent>
                <MudBadge Content="5" Color="Color.Error" Overlap="true" Class="mx-3">
                    <MudIconButton Icon="@Icons.Material.Outlined.Notifications" Color="Color.Inherit" />
                </MudBadge>
            </ActivatorContent>
            <ChildContent>
                <MudCard Elevation="0" Style="width: 350px; max-height: 450px; overflow-y: auto;">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Notificaciones</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small">Marcar todo como leído</MudButton>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudDivider />
                    <MudList T="string" Clickable="true">
                        <MudListItem Icon="@Icons.Material.Outlined.CheckCircle" IconColor="Color.Success">
                            <div class="d-flex flex-column">
                                <MudText Typo="Typo.body2"><b>Venta exitosa</b></MudText>
                                <MudText Typo="Typo.caption">Factura #F001 generada correctamente.</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Hace 5 min</MudText>
                            </div>
                        </MudListItem>
                        <MudDivider />
                        <MudListItem Icon="@Icons.Material.Outlined.Warning" IconColor="Color.Warning">
                            <div class="d-flex flex-column">
                                <MudText Typo="Typo.body2"><b>Stock Bajo</b></MudText>
                                <MudText Typo="Typo.caption">El artículo "Laptop Pro" tiene menos de 3 unidades.</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Hace 2 horas</MudText>
                            </div>
                        </MudListItem>
                        <MudDivider />
                        <MudListItem Icon="@Icons.Material.Outlined.ErrorOutline" IconColor="Color.Error">
                            <div class="d-flex flex-column">
                                <MudText Typo="Typo.body2"><b>Error de SUNAT</b></MudText>
                                <MudText Typo="Typo.caption">El documento #F002 fue rechazado por el servidor.</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Hace 1 día</MudText>
                            </div>
                        </MudListItem>
                        <MudDivider />
                        <MudListItem Icon="@Icons.Material.Outlined.PersonAdd" IconColor="Color.Info">
                            <div class="d-flex flex-column">
                                <MudText Typo="Typo.body2"><b>Nuevo Usuario</b></MudText>
                                <MudText Typo="Typo.caption">Se ha registrado el vendedor: Yahaira Vela.</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Hace 2 días</MudText>
                            </div>
                        </MudListItem>
                    </MudList>
                    <MudDivider />
                    <div class="pa-2 d-flex justify-center">
                        <MudButton Variant="Variant.Text" FullWidth="true" Color="Color.Primary">Ver todas las notificaciones</MudButton>
                    </div>
                </MudCard>
            </ChildContent>
        </MudMenu>

        @* Menú de Usuario *@
        <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" ActivationEvent="MouseEvent.LeftClick" PopoverClass="mud-popover-cascading">
            <ActivatorContent>
                @* <MudAvatar Color="Color.Secondary">FC</MudAvatar> *@
                <MudAvatar Color="Color.Secondary">@ObtenerIniciales()</MudAvatar>
            </ActivatorContent>
            <ChildContent>
                <div class="pa-4 d-flex flex-column align-center" style="min-width: 150px;">
                    <MudAvatar Color="Color.Secondary" Style="height:60px; width:60px;">@ObtenerIniciales()</MudAvatar>
                    <MudText Typo="Typo.body1" Class="mt-2" Style="font-weight: bold;">@UsuarioNombre</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">@UsuarioEmail</MudText>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Text" Class="mt-1">@UsuarioRol</MudChip>
                </div>
                <MudDivider />
                <MudMenuItem Icon="@Icons.Material.Outlined.Person">Mi Perfil</MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Outlined.Security">Seguridad</MudMenuItem>
                <MudDivider />
                <MudMenuItem Icon="@Icons.Material.Outlined.Logout" Color="Color.Error" OnClick="CerrarSesion">Cerrar Sesión</MudMenuItem>
            </ChildContent>
        </MudMenu>
    </MudAppBar>

    @* Menú Lateral (Drawer) *@
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2" Variant="@DrawerVariant.Responsive">
        <NavMenu />
    </MudDrawer>

    @* Contenido Principal *@
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="my-6">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    bool _drawerOpen = true;
    private bool _isMobile;
    private string _layoutClass = "";
    private bool _isDarkMode;

    private string UsuarioNombre => AppStateInstance.UsuarioActivo?.NombreCompleto ?? "Usuario";
    private string UsuarioEmail => AppStateInstance.UsuarioActivo?.Email ?? "Sin correo";
    private string UsuarioRol => AppStateInstance.UsuarioActivo?.Rol ?? "Invitado";

    // Generar iniciales para el Avatar (ej: "Frank Casuso" -> "FC")
    private string ObtenerIniciales()
    {
        if (string.IsNullOrWhiteSpace(UsuarioNombre)) return "??";
        var palabras = UsuarioNombre.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (palabras.Length == 1) return palabras[0][0].ToString().ToUpper();
        return (palabras[0][0].ToString() + palabras[1][0].ToString()).ToUpper();
    }

    protected override void OnInitialized()
    {
        // Detectamos si es móvil una sola vez al iniciar
        _isMobile = DeviceInfo.Current.Platform != DevicePlatform.WinUI &&
                    DeviceInfo.Current.Platform != DevicePlatform.MacCatalyst;

        // Si es móvil, aplicamos la clase que activa el CSS especial
        _layoutClass = _isMobile ? "is-mobile" : "";
        _isDarkMode = AppInfo.RequestedTheme == AppTheme.Dark;

        AppStateInstance.OnChange += HandleStateChanged;
        SyncService.OnSyncCompleted += HandleSyncSuccess; // Suscripción al éxito de la sincronización
        SyncService.OnSyncError += HandleSyncError;

        _ = Task.Run(async () =>
                {
                    try
                    {
                        await SyncService.SincronizarTodoAsync();
                    }
                    catch (Exception) { /* Loguear error de sync silencioso */ }
                });

        // Nos suscribimos al evento
        // SyncWorker.OnSyncCompleted += (mensaje) =>
        // {
        //     // ¡OJO SENIOR!: Los eventos de fondo vienen en otro hilo,
        //     // hay que pasarlos al hilo de la UI para que MudBlazor no explote.
        //     MainThread.BeginInvokeOnMainThread(() =>
        //     {
        //         Snackbar.Add(mensaje, Severity.Success);
        //         StateHasChanged();
        //     });
        // };

        // SyncWorker.Start();

    }

    private void HandleStateChanged() => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        AppStateInstance.OnChange -= HandleStateChanged;
        // ¡No olvides desuscribirte para evitar fugas de memoria!
        SyncService.OnSyncCompleted -= HandleSyncSuccess;
        SyncService.OnSyncError -= HandleSyncError;
    }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private MudTheme _dikePayTheme = new MudTheme()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#594AE2",
            Secondary = "#00C853",
            AppbarBackground = "#594AE2",
            Background = "#F5F5F9", // Un gris muy suave para el fondo
            Surface = "#FFFFFF"
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#9E93FF",         // Un violeta más claro para que resalte en negro
            Secondary = "#00E676",
            AppbarBackground = "#1A1A27",
            Background = "#121212",      // Color base de Android Dark Mode
            Surface = "#1E1E2D",         // Color para las tarjetas (MudPaper)
            DrawerBackground = "#1A1A27",
            TextPrimary = "#E3E3E3",
            ActionDefault = "#ADADB1"
        },
        LayoutProperties = new LayoutProperties()
        {
            DefaultBorderRadius = "12px", // Bordes un poco más modernos
        }
    };

    private async Task CerrarSesion(){

        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/");

    }

    private void HandleSyncSuccess(string mensaje)
    {
        // IMPORTANTE: El evento viene de un hilo de fondo del Task.Run
        // Debemos regresar al hilo de la UI para mostrar el Snackbar
        InvokeAsync(() =>
        {
            SnackbarService.Add(mensaje, Severity.Success, config =>
            {
                config.VisibleStateDuration = 5000;
                config.HideTransitionDuration = 500;
            });
            StateHasChanged();
        });
    }

    private void HandleSyncError(string mensaje)
    {
        InvokeAsync(() =>
        {
            SnackbarService.Add(mensaje, Severity.Error, config =>
            {
                config.VisibleStateDuration = 7000; // Un poco más de tiempo para errores
                config.DuplicatesBehavior = SnackbarDuplicatesBehavior.Prevent; // No llenar la pantalla de errores iguales
            });
            StateHasChanged();
        });
    }
}