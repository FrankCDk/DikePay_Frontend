@using MudBlazor
@using DikePay.Domain.Entities
@using DikePay.Application.Interfaces.Services
@inject IFacturacionQueueService QueueService
@inject IVentaService VentaRepository

<MudDialog Class="compact-dialog">
    <DialogContent>
        <div class="d-flex flex-column align-center py-6">
            @if (_isProcessing)
            {
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" Class="mb-4" />
                <MudText Typo="Typo.h6"><b>Guardando Venta...</b></MudText>
                <MudText Typo="Typo.body2" Class="mud-text-secondary">Asegurando datos en el dispositivo</MudText>
            }
            else if (_hasError)
            {
                <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Large" Style="font-size: 3rem;" />
                <MudText Typo="Typo.h6" Color="Color.Error"><b>Error de Guardado</b></MudText>
                <MudText Typo="Typo.body2" Align="Align.Center">No se pudo persistir la venta localmente.</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="() => MudDialog.Cancel()" Class="mt-4">Cerrar</MudButton>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" />
                <MudText Typo="Typo.h6" Color="Color.Success"><b>Venta Asegurada</b></MudText>
            }
        </div>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public Venta VentaData { get; set; } = null!;

    private bool _isProcessing = true;
    private bool _hasError = false;

    protected override async Task OnInitializedAsync()
    {
        await GuardarLocalmente();
    }

    private async Task GuardarLocalmente()
    {
        try
        {
            // 1. Guardar en DB Local (SQLite/LiteDB)
            // IMPORTANTE: Aquí obtienes el ID o Correlativo real de la DB
            //await VentaRepository.InsertarVentaAsync(VentaData);

            await Task.Delay(600); // Feedback visual mínimo
            _isProcessing = false;
            StateHasChanged();

            // 2. DISPARAR PROCESO FISCAL EN SEGUNDO PLANO
            // "Fuego y olvido": No esperamos el await aquí.
            _ = QueueService.ProcesarEnvioFiscal(VentaData);

            // 3. CERRAR Y CONTINUAR
            await Task.Delay(400);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception)
        {
            _isProcessing = false;
            _hasError = true;
            StateHasChanged();
        }
    }
}