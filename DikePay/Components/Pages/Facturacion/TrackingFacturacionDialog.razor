@using MudBlazor
@using DikePay.Application.Interfaces
@inject INetworkService ConnectivityService

<style>
    .mud-stepper-actions {
        display: none !important;
    }
</style>

<MudDialog>
    <DialogContent>
        <MudPaper Class="pa-4" Style="min-width:420px">

            <MudText Typo="Typo.h6" Class="mb-3" Color="Color.Primary">
                Procesando comprobante
            </MudText>

            <MudStepper Vertical HideActions="true" @bind-ActiveIndex="_activeStep">

                <MudStep Title="Generando factura"
                         Completed="@IsCompleted(0)"
                         CompletedIcon="@Icons.Material.Filled.CheckCircle"
                         SecondaryText="@GetStatusText(0)">
                    <MudText Typo="Typo.body2">
                        Registrando la venta y generando el comprobante.
                    </MudText>
                </MudStep>

                <MudStep Title="Generación de XML"
                         Completed="@IsCompleted(1)"
                         CompletedIcon="@Icons.Material.Filled.CheckCircle"
                         SecondaryText="@GetStatusText(1)">
                    <MudText Typo="Typo.body2">
                        Creando el XML electrónico.
                    </MudText>
                </MudStep>

                <MudStep Title="Declaración OSE / SUNAT"
                         Completed="@IsCompleted(2)"
                         CompletedIcon="@Icons.Material.Filled.CheckCircle"
                         SecondaryText="@GetStatusText(2)">
                    <MudText Typo="Typo.body2">
                        Enviando a OSE / SUNAT.
                    </MudText>
                </MudStep>

                <MudStep Title="Publicación"
                         Completed="@IsCompleted(3)"
                         CompletedIcon="@Icons.Material.Filled.CheckCircle"
                         SecondaryText="@GetStatusText(3)">
                    <MudText Typo="Typo.body2">
                        Publicando comprobante.
                    </MudText>
                </MudStep>

            </MudStepper>

            @if (_procesoCompleto)
            {
                <MudDivider Class="my-4" />

                <MudButton Color="Color.Primary"
                           Variant="Variant.Filled"
                           FullWidth
                           StartIcon="@Icons.Material.Filled.ReceiptLong"
                           OnClick="VerTicket">
                    Ver impresión en formato ticket
                </MudButton>

                <MudButton Color="Color.Secondary" Class="mt-3"
                           Variant="Variant.Filled"
                           FullWidth
                           StartIcon="@Icons.Material.Filled.Close"
                           OnClick="CerrarModal">
                    Cerrar
                </MudButton>
            }

            @if (_steps[2] == StepStatus.Error)
            {
                <MudAlert Severity="Severity.Error" Dense Variant="Variant.Filled" Class="mt-3">
                    No hay conexión a Internet. No se pudo enviar el comprobante a SUNAT.
                </MudAlert>

                <MudButton Color="Color.Secondary" Class="mt-3"
                           Variant="Variant.Filled"
                           FullWidth
                           StartIcon="@Icons.Material.Filled.Close"
                           OnClick="CerrarModal">
                    Cerrar
                </MudButton>
            }

        </MudPaper>
    </DialogContent>
</MudDialog>

@code {

    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = null!;

    private int _activeStep = 0;
    private bool _procesoCompleto = false;

    private readonly StepStatus[] _steps =
    {
        StepStatus.Pending,
        StepStatus.Pending,
        StepStatus.Pending,
        StepStatus.Pending
    };

    protected override async Task OnInitializedAsync()
    {
        await EjecutarProceso();
    }

    private async Task EjecutarProceso()
    {
        for (int i = 0; i < _steps.Length; i++)
        {
            _activeStep = i;
            _steps[i] = StepStatus.Processing;
            StateHasChanged();

            await Task.Delay(1500); // aquí va tu lógica real

            // 🔴 VALIDACIÓN CRÍTICA EN PASO 3 (índice 2)
            if (i == 2 && !ConnectivityService.HasInternet)
            {
                _steps[i] = StepStatus.Error;

                // El paso 4 queda pendiente explícitamente
                if (_steps.Length > 3)
                    _steps[3] = StepStatus.Pending;

                StateHasChanged();
                return; // ⛔ Cortamos el flujo
            }

            _steps[i] = StepStatus.Success;
            StateHasChanged();

            await Task.Delay(300);

            if (i < _steps.Length - 1)
                _activeStep = i + 1;
        }

        _procesoCompleto = true;
        StateHasChanged();
    }

    private void VerTicket()
    {
        MudDialog.Close(DialogResult.Ok(true));
    }

    private bool IsCompleted(int index)
        => _steps[index] == StepStatus.Success;

    private string GetStatusText(int index)
        => _steps[index] switch
        {
            StepStatus.Pending => "Pendiente",
            StepStatus.Processing => "Generando...",
            StepStatus.Success => "Completado",
            StepStatus.Error => "Error",
            _ => ""
        };

    private enum StepStatus
    {
        Pending,
        Processing,
        Success,
        Error
    }

    private void CerrarModal()
    {
        MudDialog.Cancel();
    }
}