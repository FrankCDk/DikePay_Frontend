@page "/facturacion/dashboard"
@using DikePay.Application.Services
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">
    @* Encabezado Profesional *@
    <div class="d-flex align-center justify-space-between mb-8">
        <div>
            <MudText Typo="Typo.h4" Style="font-weight: 800; color: var(--mud-palette-primary);"><b>DikePay</b> - Mis Ventas</MudText>
            <MudText Typo="Typo.body1" Class="mud-text-secondary">Bienvenido de nuevo. Aquí tienes el resumen de hoy.</MudText>
        </div>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.AddShoppingCart"
                   Size="Size.Large"
                   OnClick="@(() => Navigation.NavigateTo("/facturacion/ventas"))"
                   Style="height: 56px; padding: 0 32px; font-weight: bold; border-radius: 12px;">
            NUEVA VENTA
        </MudButton>
    </div>

    <MudGrid Spacing="3" Class="mb-8">
        @* KPI: VENTAS EN SOLES *@
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-6 d-flex flex-column" Elevation="4" Style="height:180px; border-top: 6px solid #10B981; border-radius: 12px;">
                <MudText Typo="Typo.h6" Class="mud-text-secondary" Style="font-weight: 600;">VENTAS (SOLES)</MudText>
                <MudSpacer />
                <MudText Typo="Typo.h3" Style="font-weight: 800;">S/ 1,250</MudText>
                <MudText Typo="Typo.caption" Color="Color.Success"><b>+12%</b> respecto ayer</MudText>
            </MudPaper>
        </MudItem>

        @* KPI: VENTAS EN DÓLARES *@
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-6 d-flex flex-column" Elevation="4" Style="height:180px; border-top: 6px solid #3B82F6; border-radius: 12px;">
                <MudText Typo="Typo.h6" Class="mud-text-secondary" Style="font-weight: 600;">VENTAS (USD)</MudText>
                <MudSpacer />
                <MudText Typo="Typo.h3" Style="font-weight: 800;">$ 340</MudText>
                <MudText Typo="Typo.caption">TC: 3.75</MudText>
            </MudPaper>
        </MudItem>

        @* KPI: PENDIENTES *@
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-6 d-flex flex-column" Elevation="4" Style="height:180px; border-top: 6px solid #F59E0B; border-radius: 12px;">
                <MudText Typo="Typo.h6" Class="mud-text-secondary" Style="font-weight: 600;">POR COBRAR</MudText>
                <MudSpacer />
                <div class="d-flex align-end justify-space-between">
                    <MudText Typo="Typo.h3" Style="font-weight: 800;">5</MudText>
                    <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Large" Color="Color.Warning" />
                </div>
                <MudText Typo="Typo.caption">Sincronización pendiente</MudText>
            </MudPaper>
        </MudItem>

        @* CLIENTES TOP: Sin Scroll *@
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-6 d-flex flex-column" Elevation="4" Style="height:180px; border-radius: 12px; background: #f1f5f9;">
                <MudText Typo="Typo.h6" Class="mud-text-secondary mb-2" Style="font-weight: 600;">CLIENTES TOP</MudText>
                <MudStack Spacing="1">
                    <div class="d-flex justify-space-between align-center">
                        <MudText Typo="Typo.body2"><b>1.</b> Panadería Sol</MudText>
                        <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Color="Color.Warning" />
                    </div>
                    <div class="d-flex justify-space-between align-center">
                        <MudText Typo="Typo.body2"><b>2.</b> Mini Market Lima</MudText>
                        <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Color="Color.Warning" />
                    </div>
                    <div class="d-flex justify-space-between align-center">
                        <MudText Typo="Typo.body2"><b>3.</b> Café Aroma</MudText>
                        <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Color="Color.Warning" />
                    </div>
                </MudStack>
            </MudPaper>
        </MudItem>

    </MudGrid>

    <MudGrid>
        @* Historial de Ventas *@
        <MudItem xs="12" md="8">
            <div class="d-flex align-center mb-4">
                <MudIcon Icon="@Icons.Material.Filled.History" Color="Color.Primary" Class="mr-2" />
                <MudText Typo="Typo.h5" Style="font-weight: 700;">Últimos Movimientos</MudText>
            </div>
            <MudStack Spacing="2">
                @foreach (var venta in _ventasSimuladas)
                {
                    <MudCard Elevation="1" Class="pa-1 rounded-lg border-solid border mud-border-lines-default">
                        <MudCardContent Class="d-flex align-center justify-space-between py-3">
                            <div class="d-flex align-center">
                                <MudAvatar Color="@GetAvatarColor(venta.Estado)" Variant="Variant.Text" Class="mr-4" Style="background: #f1f5f9">
                                    <MudIcon Icon="@GetIcon(venta.Estado)" />
                                </MudAvatar>
                                <div>
                                    <MudText Typo="Typo.body1" Style="font-weight: 700;">@venta.Cliente</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">DOC: @venta.Numero • @venta.Fecha.ToString("HH:mm")</MudText>
                                </div>
                            </div>
                            <div class="text-end">
                                <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-weight: 800;">S/ @venta.Total.ToString("N2")</MudText>
                                <MudChip T="string" Size="Size.Small" Color="@GetChipColor(venta.Estado)" Variant="Variant.Text" Style="font-weight: bold;">@venta.Estado.ToUpper()</MudChip>
                            </div>
                        </MudCardContent>
                    </MudCard>
                }
            </MudStack>
        </MudItem>

        @* STOCK BAJO Detallado *@
        <MudItem xs="12" md="4">
            <div class="d-flex align-center mb-4">
                <MudIcon Icon="@Icons.Material.Filled.Inventory2" Color="Color.Error" Class="mr-2" />
                <MudText Typo="Typo.h5" Style="font-weight: 700;">Alertas de Stock</MudText>
            </div>
            <MudPaper Elevation="4" Class="pa-4 rounded-xl">
                <MudList T="string" Dense="true" ReadOnly="true">
                    @foreach (var item in _stockBajo)
                    {
                        <MudListItem Class="pa-0 mb-3">
                            <div class="d-flex flex-column w-100">
                                <div class="d-flex justify-space-between align-center">
                                    <MudText Typo="Typo.body2" Style="font-weight: 700;">@item.Producto</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="@(item.Cantidad <= 2 ? Color.Error : Color.Warning)" Variant="Variant.Filled">@item.Cantidad Unid.</MudChip>
                                </div>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">Categoría: @item.Categoria</MudText>
                                <MudProgressLinear Color="@(item.Cantidad <= 2 ? Color.Error : Color.Warning)" Value="@(item.Cantidad * 10)" Class="mt-1" />
                            </div>
                        </MudListItem>
                    }
                </MudList>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" Class="mt-4" Style="border-width: 2px;">VER TODO EL INVENTARIO</MudButton>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private List<VentaPreview> _ventasSimuladas = new()
    {
        new ("F001-234", "Panadería El Sol", 120.00m, "Pagado", DateTime.Now),
        new ("B001-567", "Mini Market Lima", 250.50m, "Pendiente", DateTime.Now),
        new ("F001-235", "Panadería Central", 90.00m, "Vencido", DateTime.Now.AddDays(-1))
    };

    private List<StockAlerta> _stockBajo = new()
    {
        new ("Harina Costeño 1kg", 2, "Abarrotes"),
        new ("Leche Gloria 400g", 5, "Lácteos"),
        new ("Azúcar Rubia 1kg", 8, "Abarrotes")
    };

    private Color GetChipColor(string estado) => estado switch
    {
        "Pagado" => Color.Success,
        "Pendiente" => Color.Warning,
        "Vencido" => Color.Error,
        _ => Color.Default
    };

    private string GetIcon(string estado) => estado switch
    {
        "Pagado" => Icons.Material.Filled.CheckCircle,
        "Pendiente" => Icons.Material.Filled.Timer,
        "Vencido" => Icons.Material.Filled.Error,
        _ => Icons.Material.Filled.Description
    };

    private Color GetAvatarColor(string estado) => estado switch
    {
        "Pagado" => Color.Success,
        "Pendiente" => Color.Warning,
        "Vencido" => Color.Error,
        _ => Color.Default
    };

    public record VentaPreview(string Numero, string Cliente, decimal Total, string Estado, DateTime Fecha);
    public record StockAlerta(string Producto, int Cantidad, string Categoria);
}