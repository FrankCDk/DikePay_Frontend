@using MudBlazor
@inject ISnackbar Snackbar
@using DikePay.Helpers

<MudDialog>
    <TitleContent>
        <div class="d-flex align-center">
            <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Class="mr-2" Color="Color.Primary"/>
            <MudText Typo="Typo.h6"><b>Finalizar Transacción</b></MudText>
        </div>
    </TitleContent>
    <DialogContent>
        <MudContainer Style="max-height: 70vh; overflow-y: auto;" Class="pa-0">
            <MudStack Spacing="4">
                
                <MudPaper Elevation="0" Class="pa-4" Style="background: linear-gradient(135deg, #594ae20a 0%, #594ae21a 100%); border: 1px dashed #594AE2;">
                    <MudStack Spacing="1">
                        <div class="d-flex justify-space-between align-center">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Subtotal de productos</MudText>
                            <MudText Typo="Typo.body1">S/ @TotalVenta.ToString("N2")</MudText>
                        </div>
                        
                        <div class="d-flex justify-space-between align-center">
                            <MudText Typo="Typo.body2" Color="Color.Error">Descuento aplicado</MudText>
                            <MudText Typo="Typo.body1" Color="Color.Error">- S/ @_descuento.ToString("N2")</MudText>
                        </div>

                        <MudDivider Class="my-2" Style="background-color: #594AE2; opacity: 0.2;"/>
                        
                        <div class="d-flex justify-space-between align-end">
                            <MudText Typo="Typo.h6"><b>Total a Cobrar</b></MudText>
                            <MudText Typo="Typo.h4" Color="Color.Primary"><b>S/ @TotalFinal.ToString("N2")</b></MudText>
                        </div>
                    </MudStack>
                </MudPaper>

                <MudNumericField @bind-Value="_descuento" Label="Aplicar Descuento" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" 
                                 Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.LocalOffer"
                                 AdornmentColor="Color.Primary" Immediate="true" Min="0" Max="@TotalVenta" 
                                 HelperText="Monto fijo en Soles" />

                <div>
                    <MudText Typo="Typo.subtitle2" Class="mb-2"><b>Medio de Pago</b></MudText>
                    @* <MudChipSet T="string" @bind-SelectedValue="_metodoSeleccionado" CheckMark="true" Mandatory="true" Class="d-flex flex-wrap justify-center">
                        <MudChip Value="@("CONTADO")" Color="Color.Success" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Payments">Efectivo</MudChip>
                        <MudChip Value="@("TARJETA")" Color="Color.Info" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.CreditCard">Tarjeta</MudChip>
                        <MudChip Value="@("YAPE")" Color="Color.Secondary" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.QrCodeScanner">Yape/Plin</MudChip>
                        <MudChip Value="@("PAGOEFECTIVO")" Color="Color.Warning" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.AccountBalance">PagoEfectivo</MudChip>
                    </MudChipSet> *@
                    <MudChipSet T="string" @bind-SelectedValue="_metodoSeleccionado" CheckMark="true" Mandatory="true" Class="d-flex flex-wrap justify-center">
    
                        @* Efectivo *@
                        <MudChip Value="@("CONTADO")" Color="Color.Success" Variant="Variant.Filled" 
                                 Icon="@Icons.Material.Filled.Payments">Efectivo</MudChip>

                        @* Tarjetas - Separadas *@
                        <MudChip Value="@("VISA")" Style="color: #1a1f71; border-color: #1a1f71;" Variant="Variant.Outlined"
                                 Icon="@Icons.Custom.Brands.Microsoft">Visa</MudChip>
    
                        <MudChip Value="@("MASTERCARD")" Style="color: #eb001b; border-color: #f79e1b;" Variant="Variant.Outlined"
                                 Icon="@Icons.Material.Filled.CreditCard">Mastercard</MudChip>

                        @* Billeteras Digitales - Separadas por color de marca *@
                        <MudChip Value="@("YAPE")" Style="background-color: #742284; color: white;" Variant="Variant.Filled"
                                 Icon="@Icons.Material.Filled.QrCodeScanner">YAPE</MudChip>
    
                        <MudChip Value="@("PLIN")" Style="background-color: #00d1ce; color: white;" Variant="Variant.Filled"
                                 Icon="@Icons.Material.Filled.AdsClick">PLIN</MudChip>

                    </MudChipSet>
                </div>

                @if (_metodoSeleccionado == "CONTADO")
                {
                    <MudPaper Elevation="0" Class="pa-4" Style="background-color: #f5f5f5; border-radius: 12px;">
                        <MudNumericField @bind-Value="_montoRecibido" Label="Monto Recibido" 
                                         Variant="Variant.Filled" Adornment="Adornment.Start" AdornmentText="S/" 
                                         Immediate="true" SelectAllTextOnFocus="true" Color="Color.Primary" />
                        
                        <div class="d-flex flex-wrap gap-2 mt-3">
                            @foreach (var m in new int[] { 10, 20, 50, 100 })
                            {
                                <MudButton Variant="Variant.Filled" Color="Color.Default" Size="Size.Small" 
                                           OnClick="@(() => _montoRecibido += m)">+@m</MudButton>
                            }
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" 
                                       OnClick="@(() => _montoRecibido = TotalFinal)">Exacto</MudButton>
                        </div>

                        @if (Vuelto >= 0)
                        {
                            <div class="mt-4 pa-3 d-flex justify-space-between align-center" style="background-color: #e8f5e9; border-radius: 8px;">
                                <MudText Typo="Typo.subtitle1" Color="Color.Success"><b>Vuelto al cliente:</b></MudText>
                                <MudText Typo="Typo.h5" Color="Color.Success"><b>S/ @Vuelto.ToString("N2")</b></MudText>
                            </div>
                        }
                        else
                        {
                            <MudText Color="Color.Error" Typo="Typo.caption" Class="mt-2 d-block">Faltan S/ @(Math.Abs(Vuelto).ToString("N2")) para cubrir el total.</MudText>
                        }
                    </MudPaper>
                }
            </MudStack>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancelar" Variant="Variant.Text" Color="Color.Default" Class="px-6">Cerrar</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" 
                   Disabled="@EsPagoInvalido"
                   OnClick="ConfirmarPago" 
                   Size="Size.Large"
                   Class="px-10 py-2 rounded-pill shadow-lg">
            Finalizar Compra
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    
    [CascadingParameter] 
    IMudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter] public decimal TotalVenta { get; set; }

    private string _metodoSeleccionado = "CONTADO";
    private decimal _descuento;
    private decimal _montoRecibido;

    private decimal TotalFinal => TotalVenta - _descuento;
    private decimal Vuelto => _montoRecibido - TotalFinal;

    // Lógica Senior: Encapsular la validación
    private bool EsPagoInvalido => (_metodoSeleccionado == "CONTADO" && Vuelto < 0) || TotalFinal < 0;

    private void Cancelar() => MudDialog.Cancel();

    private void ConfirmarPago()
    {
        // En un entorno profesional, devolvemos un objeto con toda la transacción
        var resultado = new
        {
            Metodo = _metodoSeleccionado,
            TotalOriginal = TotalVenta,
            Descuento = _descuento,
            TotalPagado = TotalFinal,
            MontoRecibido = _metodoSeleccionado == "CONTADO" ? _montoRecibido : TotalFinal,
            Vuelto = _metodoSeleccionado == "CONTADO" ? Vuelto : 0
        };

        // Cerramos este diálogo devolviendo el resultado
        MudDialog.Close(DialogResult.Ok(resultado));
    }
}