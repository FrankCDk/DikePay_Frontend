@page "/facturacion/articulos"
@using DikePay.Models.Facturacion
@using MudBlazor
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
        <MudText Typo="Typo.h4" Color="Color.Primary"><b>DikePay</b> - Maestro de Artículos</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="CrearNuevoArticulo">
            Nuevo Artículo
        </MudButton>
    </MudStack>

    <MudTable T="Articulo" Items="@_articulos" Hover="true" Bordered="true" Striped="true" Elevation="1">
        <HeaderContent>
            <MudTh>Código</MudTh>
            <MudTh>Nombre</MudTh>
            <MudTh>Precio</MudTh>
            <MudTh>SKU</MudTh>
            <MudTh>Stock</MudTh>
            <MudTh Style="text-align: right;">Acciones</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Codigo">@context.Codigo</MudTd>
            <MudTd DataLabel="Nombre">@context.Nombre</MudTd>
            <MudTd DataLabel="Precio">@context.Precio.ToString("C2")</MudTd>
            <MudTd DataLabel="SKU">@context.CodigoSku</MudTd>
            <MudTd DataLabel="Stock">@context.Stock</MudTd>
            <MudTd Style="text-align: right;">
                <MudIconButton Icon="@Icons.Material.Outlined.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditarArticulo(context))" />
                <MudIconButton Icon="@Icons.Material.Outlined.QrCode" Color="Color.Info" Size="Size.Small" OnClick="@(() => MostrarBarcode(context))" Disabled="@(string.IsNullOrEmpty(context.CodigoSku))" />
                <MudIconButton Icon="@Icons.Material.Outlined.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => EliminarArticulo(context))" />
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 10, 25, 50 }" />
        </PagerContent>
    </MudTable>
</MudContainer>

@code {

    private List<Articulo> _articulos = new()
    {
        new Articulo { Codigo = "ARR", Nombre = "Arroz Costeño 1kg", Precio = 4.50m, CodigoSku = "ARR-001", Stock = 100 },
        new Articulo { Codigo = "ACE", Nombre = "Aceite Primor 1L", Precio = 11.20m, CodigoSku = "ACE-002", Stock = 50 },
        new Articulo { Codigo = "LEC", Nombre = "Leche Gloria Azul 400g", Precio = 3.80m, CodigoSku = "LEC-003", Stock = 120 },
        new Articulo { Codigo = "FID", Nombre = "Fideos Don Vittorio 500g", Precio = 3.20m, CodigoSku = "FID-004", Stock = 80 },
        new Articulo { Codigo = "DET", Nombre = "Detergente Bolívar 1kg", Precio = 9.50m, CodigoSku = "DET-005", Stock = 40 },
        new Articulo { Codigo = "ATU", Nombre = "Atún Primor Trozos", Precio = 6.50m, CodigoSku = "ATU-001", Stock = 45 },
        new Articulo { Codigo = "YOG", Nombre = "Yogurt Gloria Fresa 1L", Precio = 7.20m, CodigoSku = "YOG-002", Stock = 20 },
        new Articulo { Codigo = "GAL", Nombre = "Galletas Soda Field", Precio = 0.80m, CodigoSku = "GAL-006", Stock = 200 },
        new Articulo { Codigo = "GAS", Nombre = "Gaseosa Inca Kola 500ml", Precio = 2.50m, CodigoSku = "GAS-007", Stock = 60 },
        new Articulo { Codigo = "PAN", Nombre = "Pan de Molde Bimbo", Precio = 8.50m, CodigoSku = "PAN-008", Stock = 15 },
        new Articulo { Codigo = "SAL", Nombre = "Sal Marina Lobos 1kg", Precio = 2.00m, CodigoSku = "SAL-009", Stock = 100 },
        new Articulo { Codigo = "AZU", Nombre = "Azúcar Rubia Paramonga 1kg", Precio = 4.20m, CodigoSku = "AZU-010", Stock = 90 },
        new Articulo { Codigo = "CAF", Nombre = "Café Altomayo 200g", Precio = 15.00m, CodigoSku = "CAF-011", Stock = 30 },
        new Articulo { Codigo = "MER", Nombre = "Mermelada Fanny Fresa", Precio = 5.50m, CodigoSku = "MER-012", Stock = 25 },
        new Articulo { Codigo = "MAY", Nombre = "Mayonesa Alacena 200g", Precio = 4.80m, CodigoSku = "MAY-013", Stock = 40 },
        new Articulo { Codigo = "PAP", Nombre = "Papel Higiénico Elite 4un", Precio = 6.50m, CodigoSku = "PAP-014", Stock = 55 },
        new Articulo { Codigo = "SHA", Nombre = "Shampoo Head & Shoulders", Precio = 18.50m, CodigoSku = "SHA-015", Stock = 20 },
        new Articulo { Codigo = "JAB", Nombre = "Jabón Bolívar 150g", Precio = 2.50m, CodigoSku = "JAB-016", Stock = 80 },
        new Articulo { Codigo = "LEN", Nombre = "Lentejas Costeño 500g", Precio = 4.50m, CodigoSku = "LEN-017", Stock = 50 },
        new Articulo { Codigo = "CHO", Nombre = "Chocolate Sublime", Precio = 2.50m, CodigoSku = "CHO-018", Stock = 100 },
        new Articulo { Codigo = "QUE", Nombre = "Queso Edam Laive", Precio = 12.50m, CodigoSku = "QUE-019", Stock = 12 },
        new Articulo { Codigo = "HUE", Nombre = "Huevo de Corral (Jaba 30)", Precio = 16.50m, CodigoSku = "HUE-020", Stock = 10 },
        new Articulo { Codigo = "MAN", Nombre = "Mantequilla Gloria 200g", Precio = 6.20m, CodigoSku = "MAN-021", Stock = 35 },
        new Articulo { Codigo = "VIN", Nombre = "Vinagre Blanco Primor", Precio = 2.80m, CodigoSku = "VIN-022", Stock = 20 },
        new Articulo { Codigo = "AJI", Nombre = "Ajinomen Pollo", Precio = 1.80m, CodigoSku = "AJI-023", Stock = 150 },
        new Articulo { Codigo = "HAR", Nombre = "Harina Blanca Flor 1kg", Precio = 6.50m, CodigoSku = "HAR-024", Stock = 40 },
        new Articulo { Codigo = "AVE", Nombre = "Avena 3 Ositos 500g", Precio = 3.50m, CodigoSku = "AVE-025", Stock = 60 }
    };


    protected override void OnInitialized()
    {
    }

    private async Task CrearNuevoArticulo()
    {
        var nuevoArticulo = new Articulo { Codigo = string.Empty, Stock = 0, Precio = 0m, Nombre = string.Empty, CodigoSku = string.Empty };
        var parameters = new DialogParameters { ["Articulo"] = nuevoArticulo };

        var dialog = await DialogService.ShowAsync<DikePay.Components.Shared.ArticuloFormDialog>("Nuevo Artículo", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is Articulo articuloGuardado)
        {
            _articulos.Add(articuloGuardado);
            Snackbar.Add("Artículo creado con éxito!", Severity.Success);
            StateHasChanged();
        }
        else
        {
            // Si el usuario cancela, revertimos el Id generado
            //_nextId--;
        }
    }

    private async Task EditarArticulo(Articulo articulo)
    {
        
    }

    private async Task EliminarArticulo(Articulo articulo)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Eliminar Artículo",
            $"¿Estás seguro de que deseas eliminar el artículo '{articulo.Nombre}' (SKU: {articulo.CodigoSku})?",
            yesText: "Sí", cancelText: "No");

        if (result == true)
        {
            _articulos.Remove(articulo);
            Snackbar.Add("Artículo eliminado.", Severity.Info);
            StateHasChanged();
        }
    }

    private async Task MostrarBarcode(Articulo articulo)
    {
        if (string.IsNullOrEmpty(articulo.CodigoSku))
        {
            Snackbar.Add("Este artículo no tiene un Código SKU asignado.", Severity.Warning);
            return;
        }

        var parameters = new DialogParameters { ["CodigoSku"] = articulo.CodigoSku };
        await DialogService.ShowAsync<BarcodeDisplayDialog>($"Código de Barras: {articulo.Nombre}", parameters);
    }
}