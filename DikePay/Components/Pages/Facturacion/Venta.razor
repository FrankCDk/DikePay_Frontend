@page "/facturacion/ventas"
@using DikePay.Domain.Entities
@using DikePay.Application.DTOs.Impresion
@using DikePay.Helpers
@using DikePay.Application.Interfaces.Repositories
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject BarcodeScannerService ScannerService
@inject IArticuloRepository ArticuloRepository

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-2 mt-md-4">
    <MudText Typo="Typo.h4" Class="mb-4" Color="Color.Primary"><b>DikePay</b> - Nueva Venta</MudText>

    <MudGrid Spacing="2">
        <MudItem xs="12" md="4">
            <MudStack Spacing="3">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.subtitle2" Class="mb-2"><b>Comprobante</b></MudText>
                    <MudGrid Spacing="1">
                        <MudItem xs="6">
                            <MudSelect T="string" Label="Tipo" @bind-Value="_tipoDoc" Variant="Variant.Outlined" Margin="Margin.Dense">
                                <MudSelectItem Value="@("Boleta")" />
                                <MudSelectItem Value="@("Factura")" />
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="6">
                            <MudSelect T="string" Label="Moneda" @bind-Value="_moneda" Variant="Variant.Outlined" Margin="Margin.Dense">
                                <MudSelectItem Value="@("PEN")">Soles</MudSelectItem>
                                <MudSelectItem Value="@("USD")">Dólares</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12">
                            <MudAutocomplete T="string" Label="Cliente" @bind-Value="_clienteNombre" SearchFunc="@SearchClientes"
                                             Variant="Variant.Outlined" Margin="Margin.Dense" Dense="true" />
                        </MudItem>
                    </MudGrid>
                </MudPaper>

                <MudPaper Class="pa-4" Elevation="2">
                    <div class="d-flex align-center justify-space-between mb-2">
                        <MudText Typo="Typo.subtitle2"><b>Artículos</b></MudText>

                        @* BOTÓN DE CÁMARA: Solo visible en móviles reales *@
                        @if (IsMobile)
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.CameraAlt"
                                           Color="Color.Primary"
                                           Variant="Variant.Filled"
                                           Size="Size.Medium"
                                           OnClick="AbrirEscanner" />
                        }
                    </div>

                    <MudAutocomplete T="Articulo" Label="Nombre o SKU" @bind-Value="_productoSeleccionado"
                                     SearchFunc="@SearchProductos" ToStringFunc="@(p => p?.Nombre)"
                                     Variant="Variant.Outlined" Margin="Margin.Dense" MaxItems="27" />

                    <div class="d-flex align-center mt-3">
                        <MudNumericField @bind-Value="_cantidadAgregar" Label="Cant." Min="1" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mr-2" />
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AgregarAlCarrito" FullWidth="true" Style="height: 40px;">
                            Agregar
                        </MudButton>
                    </div>
                </MudPaper>
            </MudStack>
        </MudItem>

        <MudItem xs="12" md="8">
            <MudTable Items="@_carrito" Hover="true" Elevation="2" Dense="true" FixedHeader="true" Height="350px">
                <HeaderContent>
                    <MudTh>Producto</MudTh>
                    <MudTh Style="text-align:right">Subtotal</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <MudText Typo="Typo.body2"><b>@context.Producto.Nombre</b></MudText>
                        <MudText Typo="Typo.caption">@context.Cantidad x @_simboloMoneda @context.PrecioUnitario</MudText>
                    </MudTd>
                    <MudTd Style="text-align:right">@_simboloMoneda @context.Subtotal.ToString("N2")</MudTd>
                    <MudTd Style="text-align:right">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => EliminarItem(context))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
            <MudPaper Class="pa-4 mt-3 d-flex justify-space-between align-center" 
              Elevation="4" 
              Style="@($"background-color: var(--mud-palette-primary); color: var(--mud-palette-primary-text);")">
                <div>
                    @* Usamos la variable de texto contrastante para que siempre sea legible *@
                    <MudText Typo="Typo.caption" Style="opacity: 0.7;">TOTAL</MudText>
                    <MudText Typo="Typo.h5"><b>@_simboloMoneda @_totalVenta.ToString("N2")</b></MudText>
                </div>
                @* Usamos Variant.Filled y color Surface para que el botón resalte sobre el fondo Primary *@
                <MudButton Variant="Variant.Filled" 
                           Style="@($"background-color: var(--mud-palette-surface); color: var(--mud-palette-primary); font-weight: bold;")"
                           Size="Size.Large"
                           Disabled="@(!_carrito.Any())" 
                           OnClick="ProcesarPago">
                    PAGAR
                </MudButton>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    // Datos de Cabecera
    private string _tipoDoc = "Boleta";
    private string _moneda = "PEN";
    private string _vendedor = "Juan Programador"; // Simular usuario logueado
    private string _clienteNombre = "Público General";
    private string _simboloMoneda => _moneda == "PEN" ? "S/" : "$";
    private bool IsMobile => DeviceInfo.Current.Platform == DevicePlatform.Android || DeviceInfo.Current.Platform == DevicePlatform.iOS;

    // Datos de Productos (Tienda de Abarrotes)
    // private List<Articulo> _productosDisponibles = new()
    // {
    //     new Articulo { Codigo = "ARR", Nombre = "Arroz Costeño 1kg", Precio = 4.50m, CodigoSku = "ARR-001", Stock = 100 },
    //     new Articulo { Codigo = "ACE", Nombre = "Aceite Primor 1L", Precio = 11.20m, CodigoSku = "ACE-002", Stock = 50 },
    //     new Articulo { Codigo = "LEC", Nombre = "Leche Gloria Azul 400g", Precio = 3.80m, CodigoSku = "LEC-003", Stock = 120 },
    //     new Articulo { Codigo = "FID", Nombre = "Fideos Don Vittorio 500g", Precio = 3.20m, CodigoSku = "FID-004", Stock = 80 },
    //     new Articulo { Codigo = "DET", Nombre = "Detergente Bolívar 1kg", Precio = 9.50m, CodigoSku = "DET-005", Stock = 40 },
    //     new Articulo { Codigo = "ATU", Nombre = "Atún Primor Trozos", Precio = 6.50m, CodigoSku = "ATU-001", Stock = 45 },
    //     new Articulo { Codigo = "YOG", Nombre = "Yogurt Gloria Fresa 1L", Precio = 7.20m, CodigoSku = "YOG-002", Stock = 20 },
    //     new Articulo { Codigo = "GAL", Nombre = "Galletas Soda Field", Precio = 0.80m, CodigoSku = "GAL-006", Stock = 200 },
    //     new Articulo { Codigo = "GAS", Nombre = "Gaseosa Inca Kola 500ml", Precio = 2.50m, CodigoSku = "GAS-007", Stock = 60 },
    //     new Articulo { Codigo = "PAN", Nombre = "Pan de Molde Bimbo", Precio = 8.50m, CodigoSku = "PAN-008", Stock = 15 },
    //     new Articulo { Codigo = "SAL", Nombre = "Sal Marina Lobos 1kg", Precio = 2.00m, CodigoSku = "SAL-009", Stock = 100 },
    //     new Articulo { Codigo = "AZU", Nombre = "Azúcar Rubia Paramonga 1kg", Precio = 4.20m, CodigoSku = "AZU-010", Stock = 90 },
    //     new Articulo { Codigo = "CAF", Nombre = "Café Altomayo 200g", Precio = 15.00m, CodigoSku = "CAF-011", Stock = 30 },
    //     new Articulo { Codigo = "MER", Nombre = "Mermelada Fanny Fresa", Precio = 5.50m, CodigoSku = "MER-012", Stock = 25 },
    //     new Articulo { Codigo = "MAY", Nombre = "Mayonesa Alacena 200g", Precio = 4.80m, CodigoSku = "MAY-013", Stock = 40 },
    //     new Articulo { Codigo = "PAP", Nombre = "Papel Higiénico Elite 4un", Precio = 6.50m, CodigoSku = "PAP-014", Stock = 55 },
    //     new Articulo { Codigo = "SHA", Nombre = "Shampoo Head & Shoulders", Precio = 18.50m, CodigoSku = "SHA-015", Stock = 20 },
    //     new Articulo { Codigo = "JAB", Nombre = "Jabón Bolívar 150g", Precio = 2.50m, CodigoSku = "JAB-016", Stock = 80 },
    //     new Articulo { Codigo = "LEN", Nombre = "Lentejas Costeño 500g", Precio = 4.50m, CodigoSku = "LEN-017", Stock = 50 },
    //     new Articulo { Codigo = "CHO", Nombre = "Chocolate Sublime", Precio = 2.50m, CodigoSku = "CHO-018", Stock = 100 },
    //     new Articulo { Codigo = "QUE", Nombre = "Queso Edam Laive", Precio = 12.50m, CodigoSku = "QUE-019", Stock = 12 },
    //     new Articulo { Codigo = "HUE", Nombre = "Huevo de Corral (Jaba 30)", Precio = 16.50m, CodigoSku = "HUE-020", Stock = 10 },
    //     new Articulo { Codigo = "MAN", Nombre = "Mantequilla Gloria 200g", Precio = 6.20m, CodigoSku = "MAN-021", Stock = 35 },
    //     new Articulo { Codigo = "VIN", Nombre = "Vinagre Blanco Primor", Precio = 2.80m, CodigoSku = "VIN-022", Stock = 20 },
    //     new Articulo { Codigo = "AJI", Nombre = "Ajinomen Pollo", Precio = 1.80m, CodigoSku = "AJI-023", Stock = 150 },
    //     new Articulo { Codigo = "HAR", Nombre = "Harina Blanca Flor 1kg", Precio = 6.50m, CodigoSku = "HAR-024", Stock = 40 },
    //     new Articulo { Codigo = "AVE", Nombre = "Avena 3 Ositos 500g", Precio = 3.50m, CodigoSku = "AVE-025", Stock = 60 }
    // };

    private List<Articulo> _productosDisponibles;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _productosDisponibles = await CargarProductos();
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error al cargar productos: " + ex.Message, Severity.Error);
        }
    }

    private async Task<List<Articulo>> CargarProductos()
    {
        return await ArticuloRepository.GetAllAsync();
    }


    private List<string> _clientesFrecuentes = new() { "Público General", "Empresa ABC SAC", "Juan Pérez", "María García" };

    private List<DetalleVenta> _carrito = new();
    private Articulo? _productoSeleccionado;
    private int _cantidadAgregar = 1;
    private decimal _totalVenta => _carrito.Sum(x => x.Subtotal);

    private async Task<IEnumerable<string>> SearchClientes(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value)) return _clientesFrecuentes;
        return _clientesFrecuentes.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private async Task<IEnumerable<Articulo>> SearchProductos(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value)) return _productosDisponibles;
        return _productosDisponibles.Where(x => x.Nombre.Contains(value, StringComparison.InvariantCultureIgnoreCase) ||
                                               x.CodigoSku.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private void AgregarAlCarrito()
    {
        if (_productoSeleccionado == null) return;

        var itemExistente = _carrito.FirstOrDefault(x => x.Producto.Codigo == _productoSeleccionado.Codigo);

        if (itemExistente != null)
        {
            itemExistente.Cantidad += _cantidadAgregar;
        }
        else
        {
            // Usamos el constructor que "congela" el precio
            _carrito.Add(new DetalleVenta(_productoSeleccionado, _cantidadAgregar));
        }

        _productoSeleccionado = null;
        _cantidadAgregar = 1;
    }

    private void EliminarItem(DetalleVenta item) => _carrito.Remove(item);

    private async Task AbrirEscanner()
    {
        var status = await Permissions.RequestAsync<Permissions.Camera>();
        if (status != PermissionStatus.Granted)
        {
            Snackbar.Add("Permiso de cámara denegado", Severity.Error);
            return;
        }

        var sku = await ScannerService.ScanAsync();
        if (!string.IsNullOrEmpty(sku))
        {
            await BuscarYAgregarPorSku(sku);
        }
    }


    private async Task BuscarYAgregarPorSku(string sku)
    {
        var prod = _productosDisponibles.FirstOrDefault(x => x.CodigoSku == sku);

        if (prod != null)
        {
            _productoSeleccionado = prod;
            AgregarAlCarrito();
            Snackbar.Add($"Escaneado: {prod.Nombre}", Severity.Success);
        }
        else
        {
            Snackbar.Add($"Código {sku} no reconocido", Severity.Warning);
        }
    }

    private async Task ProcesarPago()
    {
        // 1. DIÁLOGO DE PAGO
        var parametersPago = new DialogParameters<PagoDialog> {
        { x => x.TotalVenta, _totalVenta }
    };

        var optionsStandard = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            BackdropClick = false
        };

        var dialogPago = await DialogService.ShowAsync<PagoDialog>("Finalizar Venta", parametersPago, optionsStandard);
        var resultPago = await dialogPago.Result;

        // Si el usuario canceló el pago, nos detenemos aquí
        if (resultPago.Canceled || resultPago.Data == null) return;

        // --- AQUÍ ESTABA EL "HUECO" ---

        // 2. DIÁLOGO DE TRACKING (EL STEPPER)
        // Usamos opciones más estrictas para que no lo cierren por accidente
        var optionsTracking = new DialogOptions
        {
            CloseButton = false,
            BackdropClick = false,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialogTracking = await DialogService.ShowAsync<TrackingFacturacionDialog>("Estado de Emisión", optionsTracking);
        var resultTracking = await dialogTracking.Result;

        // Si el proceso de tracking terminó (Ok), mostramos el ticket
        if (!resultTracking.Canceled)
        {
            // 3. DIÁLOGO DE TICKET EXITOSO
            dynamic datos = resultPago.Data;

            var productosParaTicket = _carrito.Select(item => new TicketItemDto
            {
                Nombre = item.Producto.Nombre,
                Precio = item.PrecioUnitario,
                Cantidad = item.Cantidad
            }).ToList();

            await MostrarTicketExitoso(datos, productosParaTicket);

            // Limpieza final
            _carrito.Clear();
            Snackbar.Add("Venta registrada y declarada con éxito", Severity.Success);
            StateHasChanged();
        }
    }

    // CORREGIDO: Ahora el método acepta la lista de productos preparada
    private async Task MostrarTicketExitoso(dynamic datos, List<TicketItemDto> productos)
    {
        var parametersExito = new DialogParameters<VentaExitosaDialog>
        {
            { x => x.TotalPagado, (decimal)datos.TotalPagado },
            { x => x.Descuento, (decimal)datos.Descuento },
            { x => x.MetodoPago, (string)datos.Metodo },
            { x => x.ProductosVendidos, productos }, 
            { x => x.SerieNumero, $"B001-{DateTime.Now:mmssff}" } 
        };

        var options = new DialogOptions { CloseButton = false, MaxWidth = MaxWidth.Small, FullWidth = true };
        await DialogService.ShowAsync<VentaExitosaDialog>("Comprobante", parametersExito, options);
    }

}