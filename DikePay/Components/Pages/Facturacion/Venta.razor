@page "/facturacion/ventas"
@using DikePay.Domain.Entities
@using DikePay.Application.DTOs.Impresion
@using DikePay.Helpers
@using DikePay.Application.Interfaces.Repositories
@using DikePay.Components.Pages.Clientes
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject BarcodeScannerService ScannerService
@inject IArticuloRepository ArticuloRepository

<style>
    /* 1. ESTILOS DE COMPONENTES CUSTOM */
    .custom-toggle-group {
        background-color: #f0f0f0;
        border-radius: 12px;
        padding: 4px;
    }

    .custom-toggle-group .mud-toggle-item {
        border-radius: 8px !important;
        margin: 2px;
        border: none !important;
        text-transform: none;
        font-weight: bold;
    }

    .custom-toggle-group .mud-toggle-item-selected {
        background-color: white !important;
        color: black !important;
        box-shadow: 0px 2px 4px rgba(0,0,0,0.1);
    }

    /* 2. ESTILOS DE LAYOUT MÓVIL */
    .total-display-compact {
        background-color: var(--mud-palette-primary-darken);
        color: white;
        border-radius: 8px;
        padding: 10px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .mobile-table-container {
        /* Altura calculada para que el scroll sea interno y no mueva las pestañas */
        height: calc(100vh - 300px);
        overflow-y: auto;
    }

    /* Limpieza de bordes de tabla para estilo App */
    .mud-table-clean .mud-table-cell {
        border-right: none !important;
        border-left: none !important;
        padding: 8px 4px !important;
    }

    .mud-tabs-toolbar {
        height: 48px !important;
    }

    body {
        overflow: hidden; /* Evita scroll doble en móviles */
    }


    /* Ajuste para que los iconos de los inputs densos no ocupen mucho espacio */
    .mud-input-adornment-end {
        margin-left: 0 !important;
    }
    
    /* Para que el DatePicker móvil no sea gigante */
    .mud-picker-inline {
        margin-top: 0 !important;
    }

    /* Forzar que el contenedor del cliente no tenga overflow que desalinee el botón */
    .d-flex.align-center.gap-2 {
        display: flex;
        align-items: flex-start !important; /* Alineamos arriba y el margin-top del botón hace el resto */
    }

    /* Mejora visual para los campos densos */
    .mud-input-control.mud-input-control-margin-dense {
        margin-top: 4px;
    }

</style>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-2 mt-md-4">
    <MudText Typo="Typo.h4" Class="mb-4 d-none d-md-block" Color="Color.Primary" Style="font-weight: 700;">
        <b>DikePay</b> - Nueva Venta
    </MudText>

    @if (IsMobile)
    {
        @* VISTA MÓVIL OPTIMIZADA *@
        <MudContainer Class="pa-2">
            <MudTabs Elevation="2" Rounded="true" Centered="true" Color="Color.Primary" PanelClass="pa-2">
                
                @* PESTAÑA 1: VENTA (Foco en velocidad de carga) *@
                <MudTabPanel Text="Venta" Icon="@Icons.Material.Filled.ShoppingCart">
                    
                    @* HEADER DE IMPORTE (Siempre visible al vendedor) *@
                    <div class="total-display-compact">
                        <MudText Typo="Typo.subtitle2">TOTAL A COBRAR</MudText>
                        <MudText Typo="Typo.h6"><b>@_simboloMoneda @_totalVenta.ToString("N2")</b></MudText>
                    </div>

                    @* FILA DE ENTRADA COMPACTA *@
                    <div class="d-flex align-center gap-1 mb-2">
                        <MudIconButton Icon="@Icons.Material.Filled.CameraAlt" Color="Color.Primary" 
                                       Variant="Variant.Filled" OnClick="AbrirEscanner" Size="Size.Small" />
                        
                        <div style="flex-grow: 1; min-width: 0;">
                            <MudAutocomplete T="Articulo" Placeholder="Producto..." @bind-Value="_productoSeleccionado"
                                             SearchFunc="@SearchProductos" ToStringFunc="@(p => p?.Nombre)"
                                             Variant="Variant.Outlined" Margin="Margin.Dense" Dense="true" />
                        </div>

                        <div style="width: 55px;">
                            <MudNumericField @bind-Value="_cantidadAgregar" Placeholder="Cant" Min="1" 
                                             Variant="Variant.Outlined" Margin="Margin.Dense" HideSpinButtons="true" />
                        </div>

                        <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Success" 
                                       Variant="Variant.Filled" OnClick="AgregarAlCarrito" Size="Size.Small" />
                    </div>

                    @* TABLA SIN BORDES CON SCROLL INTERNO *@
                    <div class="mobile-table-container">
                        @RenderSeccionVentaSoloTabla()
                    </div>
                </MudTabPanel>

                @* PESTAÑA 2: INFO Y CIERRE DE VENTA *@
                <MudTabPanel Text="Pagar" Icon="@Icons.Material.Filled.CheckCircle">
                    <MudStack Spacing="3" Class="mt-2">
                        @RenderSeccionComprobante()
                        
                        <MudDivider Class="my-2" />
                        
                        <div class="pa-4 mud-text-align-center">
                            <MudText Typo="Typo.body1" Color="Color.Secondary">Resumen de cobro</MudText>
                            <MudText Typo="Typo.h4" Class="mb-6"><b>@_simboloMoneda @_totalVenta.ToString("N2")</b></MudText>
                            
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Warning" 
                                       FullWidth="true" 
                                       Size="Size.Large"
                                       Disabled="@(!_carrito.Any())"
                                       OnClick="ProcesarPago"
                                       Style="height: 64px; font-weight: 900; font-size: 1.3rem; color: black;">
                                FINALIZAR Y PAGAR
                            </MudButton>
                        </div>
                    </MudStack>
                </MudTabPanel>
            </MudTabs>
        </MudContainer>
    }
    else
    {
        @* VISTA ESCRITORIO (Standard MudGrid) *@
        <MudGrid Spacing="2">
            <MudItem xs="12" md="4">
                <MudStack Spacing="3">
                    @RenderSeccionComprobante()
                </MudStack>
            </MudItem>

            <MudItem xs="12" md="8">
                <MudStack Spacing="3">
                    @RenderSeccionVenta()
                </MudStack>
            </MudItem>

            <MudItem xs="12">
                @RenderBarraAccion()
            </MudItem>
        </MudGrid>
    }
</MudContainer>


@code {

    RenderFragment RenderSeccionVentaSoloTabla() => __builder => {
        <MudTable Items="@_carrito" Hover="true" Elevation="0" Dense="true" Bordered="false" Class="mud-table-clean">
            <HeaderContent>
                <MudTh>Detalle</MudTh>
                <MudTh Style="text-align:right">Total</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <MudText Typo="Typo.body2" Style="font-size: 0.85rem; line-height: 1.1;"><b>@context.Producto.Nombre</b></MudText>
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@context.Cantidad x @context.PrecioUnitario</MudText>
                </MudTd>
                <MudTd Style="text-align:right; vertical-align: middle;">
                    <MudText Typo="Typo.body2"><b>@context.Subtotal.ToString("N2")</b></MudText>
                </MudTd>
                <MudTd Style="text-align:right; width: 40px;">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => EliminarItem(context))" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    };

//     RenderFragment RenderSeccionComprobante() => __builder => {
//     <MudPaper Class="pa-2" Elevation="1"> @* Reducido de pa-4 a pa-2 *@
//         <MudText Typo="Typo.caption" Class="mb-1" Style="font-weight: bold; color: gray;">DATOS DEL COMPROBANTE</MudText>
//         <MudGrid Spacing="1" Class="ma-0"> @* Spacing mínimo *@
//             <MudItem xs="12" Class="pa-1">
//                 <MudToggleGroup T="string" @bind-Value="_tipoDoc" Delimiters="false" 
//                                 Size="Size.Small" Class="mud-width-full custom-toggle-group">
//                     <MudToggleItem Value="@("Boleta")" Text="Boleta" />
//                     <MudToggleItem Value="@("Factura")" Text="Factura" />
//                 </MudToggleGroup>
//             </MudItem>
//             <MudItem xs="5" Class="pa-1">
//                 <MudSelect T="string" Label="Moneda" @bind-Value="_moneda" Variant="Variant.Outlined" Margin="Margin.Dense" Dense="true">
//                     <MudSelectItem Value="@("PEN")">Soles</MudSelectItem>
//                     <MudSelectItem Value="@("USD")">Dólares</MudSelectItem>
//                 </MudSelect>
//             </MudItem>
//             <MudItem xs="7" Class="pa-1">
//                  <MudAutocomplete T="string" Label="Cliente" @bind-Value="_clienteNombre" SearchFunc="@SearchClientes"
//                                Variant="Variant.Outlined" Margin="Margin.Dense" Dense="true" />
//             </MudItem>
//         </MudGrid>
//     </MudPaper>
// };

RenderFragment RenderSeccionComprobante() => __builder => {
    <MudPaper Class="pa-3" Elevation="1">
        <MudText Typo="Typo.caption" Class="mb-3 d-block" Style="font-weight: bold; color: gray; letter-spacing: 1px;">
            DATOS DEL COMPROBANTE
        </MudText>
        
        <MudGrid Spacing="2">
            @* Fila 1: Tipo de Documento *@
            <MudItem xs="12" Class="mb-4">
                <MudToggleGroup T="string" @bind-Value="_tipoDoc" Delimiters="false" 
                                Size="Size.Small" Class="mud-width-full custom-toggle-group">
                    <MudToggleItem Value="@("Boleta")" Text="Boleta" />
                    <MudToggleItem Value="@("Factura")" Text="Factura" />
                </MudToggleGroup>
            </MudItem>

            @* Fila 2: Fecha y Moneda (Separados con spacing) *@
            <MudItem xs="6">
                <MudDatePicker Label="Fecha Emisión" @bind-Date="_fechaEmision" 
                               Variant="Variant.Outlined" Margin="Margin.Dense" 
                               DateFormat="dd/MM/yyyy" Editable="true" />
            </MudItem>

            <MudItem xs="6">
                <MudSelect T="string" Label="Moneda" @bind-Value="_moneda" Variant="Variant.Outlined" Margin="Margin.Dense" Dense="true">
                    <MudSelectItem Value="@("PEN")">
                        <div class="d-flex align-center">
                            <MudText Typo="Typo.body2" Class="mr-2"><b>S/</b></MudText> Soles
                        </div>
                    </MudSelectItem>
                    <MudSelectItem Value="@("USD")">
                        <div class="d-flex align-center">
                            <MudText Typo="Typo.body2" Class="mr-2"><b>$</b></MudText> Dólares
                        </div>
                    </MudSelectItem>
                </MudSelect>
            </MudItem>

            @* Fila 3: Cliente (Alineación corregida) *@
            <MudItem xs="12" Class="mt-4">
                <div class="d-flex align-center gap-2">
                    <div style="flex-grow: 1;">
                        <MudAutocomplete T="string" Label="Cliente" @bind-Value="_clienteNombre" SearchFunc="@SearchClientes"
                                       Variant="Variant.Outlined" Margin="Margin.Dense" Dense="true" 
                                       ResetValueOnEmptyText="true" CoerceText="true"
                                       AdornmentIcon="@Icons.Material.Filled.Search" AdornmentColor="Color.Primary" />
                    </div>
                    @* El margin-top compensa el espacio de la "Label" del input para que el botón baje *@
                    <div style="margin-top: 8px;">
                        <MudTooltip Text="Nuevo Cliente">
                            <MudIconButton Icon="@Icons.Material.Filled.PersonAdd" Color="Color.Success" 
                                           Variant="Variant.Filled" OnClick="AbrirRegistroCliente" Size="Size.Medium" 
                                           Style="height: 37px; width: 40px; border-radius: 8px;" />
                        </MudTooltip>
                    </div>
                </div>
            </MudItem>
        </MudGrid>
    </MudPaper>
};

RenderFragment RenderSeccionVenta() => __builder => {
        <MudPaper Class="pa-4" Elevation="1">
            <div class="d-flex align-center gap-2 mb-4">
                <MudAutocomplete T="Articulo" Label="Producto" @bind-Value="_productoSeleccionado"
                                 SearchFunc="@SearchProductos" ToStringFunc="@(p => p?.Nombre)"
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Class="flex-grow-1" />
                <MudNumericField @bind-Value="_cantidadAgregar" Label="Cant." Min="1" Variant="Variant.Outlined" Margin="Margin.Dense" Style="width: 80px;" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AgregarAlCarrito" Style="height: 40px;">Agregar</MudButton>
            </div>
            @RenderSeccionVentaSoloTabla()
        </MudPaper>
    };

    // 2. BARRA DE ACCIÓN PERSISTENTE
    RenderFragment RenderBarraAccion() => __builder => {
        bool tieneItems = _carrito.Any();
        
        <MudPaper Class="pa-4 d-flex justify-space-between align-center" Elevation="4" 
                  Style="@($"background-color: var(--mud-palette-primary); color: white; border-radius: 12px;")">
            <div>
                <MudText Typo="Typo.caption" Style="opacity: 0.8; line-height: 1;">TOTAL A COBRAR</MudText>
                <MudText Typo="Typo.h5"><b>@_simboloMoneda @_totalVenta.ToString("N2")</b></MudText>
            </div>
            <MudButton Variant="Variant.Filled" 
                       Color="@(tieneItems ? Color.Warning : Color.Surface)" 
                       Size="Size.Large" 
                       Disabled="@(!tieneItems)" 
                       OnClick="ProcesarPago" 
                       Style="@($"font-weight: 900; min-width: 120px; {(tieneItems ? "color: black;" : "color: var(--mud-palette-primary);")}")">
                PAGAR
            </MudButton>
        </MudPaper>
    };





    // Datos de Cabecera
    private string _tipoDoc = "Boleta";
    private string _moneda = "PEN";
    private string _vendedor = "Juan Programador"; // Simular usuario logueado
    private string _clienteNombre = "Público General";
    private string _simboloMoneda => _moneda == "PEN" ? "S/" : "$";
    private decimal _descuentoAgregar = 0;
    private DateTime? _fechaEmision = DateTime.Today;
    private bool IsMobile => DeviceInfo.Current.Platform == DevicePlatform.Android || DeviceInfo.Current.Platform == DevicePlatform.iOS;

    private List<Articulo> _productosDisponibles;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _productosDisponibles = await CargarProductos();
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error al cargar productos: " + ex.Message, Severity.Error);
        }
    }

    private async Task<List<Articulo>> CargarProductos()
    {
        return await ArticuloRepository.GetAllAsync();
    }

    private async Task AbrirRegistroCliente()
    {
        var options = new DialogOptions { 
            CloseButton = true, 
            MaxWidth = MaxWidth.ExtraSmall, 
            FullWidth = true,
            BackdropClick = true 
        };

        // Aquí llamarías a tu componente de diálogo para crear cliente
        var dialog = await DialogService.ShowAsync<NuevoClienteDialog>("Registrar Cliente", options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null)
        {
            // Supongamos que el diálogo devuelve el nombre o el objeto cliente
            _clienteNombre = result.Data.ToString();
            // Opcional: recargar lista de clientes frecuentes
            Snackbar.Add("Cliente registrado y seleccionado", Severity.Success);
        }
    }


    private List<string> _clientesFrecuentes = new() { "Público General", "Empresa ABC SAC", "Juan Pérez", "María García" };

    private List<DetalleVenta> _carrito = new();
    private Articulo? _productoSeleccionado;
    private int _cantidadAgregar = 1;
    private decimal _totalVenta => _carrito.Sum(x => x.Subtotal);

    private async Task<IEnumerable<string>> SearchClientes(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value)) return _clientesFrecuentes;
        return _clientesFrecuentes.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private async Task<IEnumerable<Articulo>> SearchProductos(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value)) return _productosDisponibles;
        return _productosDisponibles.Where(x => x.Nombre.Contains(value, StringComparison.InvariantCultureIgnoreCase) ||
                                               x.CodigoSku.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private void AgregarAlCarrito()
    {
        if (_productoSeleccionado == null) return;

        var itemExistente = _carrito.FirstOrDefault(x => x.Producto.Codigo == _productoSeleccionado.Codigo);

        if (itemExistente != null)
        {
            itemExistente.Cantidad += _cantidadAgregar;
            itemExistente.Descuento = _descuentoAgregar;
        }
        else
        {
            // Usamos el constructor que "congela" el precio
            var nuevoDetalle = new DetalleVenta(_productoSeleccionado, _cantidadAgregar, _descuentoAgregar);
            _carrito.Add(nuevoDetalle);
        }

        _productoSeleccionado = null;
        _cantidadAgregar = 1;
        _descuentoAgregar = 0;
        StateHasChanged();
    }

    private void EliminarItem(DetalleVenta item) => _carrito.Remove(item);

    private async Task AbrirEscanner()
    {
        var status = await Permissions.RequestAsync<Permissions.Camera>();
        if (status != PermissionStatus.Granted)
        {
            Snackbar.Add("Permiso de cámara denegado", Severity.Error);
            return;
        }

        var sku = await ScannerService.ScanAsync();
        if (!string.IsNullOrEmpty(sku))
        {
            await BuscarYAgregarPorSku(sku);
        }
    }


    private async Task BuscarYAgregarPorSku(string sku)
    {
        var prod = _productosDisponibles.FirstOrDefault(x => x.CodigoSku == sku);

        if (prod != null)
        {
            // 1. Definimos los parámetros usando strings para evitar el error de la lambda
            var parameters = new DialogParameters();
            parameters.Add("Articulo", prod);
            parameters.Add("CantidadInicial", 1);

            var options = new DialogOptions
            {
                CloseButton = true,
                MaxWidth = MaxWidth.ExtraSmall,
                FullWidth = true,
                BackdropClick = false // Obliga al vendedor a interactuar
            };

            // 2. Llamamos al diálogo (asegúrate que el nombre coincida con el archivo .razor)
            try {

                var dialog = await DialogService.ShowAsync<EdicionRapidaItemDialog>("Confirmar Producto", parameters, options);
                var result = await dialog.Result;

                if (!result.Canceled && result.Data != null)
                {
                    // 3. Leemos los datos ajustados (usando dynamic para facilidad)
                    dynamic data = result.Data;
                    int cant = data.CantidadSeleccionada;
                    decimal precio = data.PrecioAplicado;

                    // 4. Agregamos al carrito con los valores finales
                    var itemExistente = _carrito.FirstOrDefault(x => x.Producto.Codigo == prod.Codigo);
                    if (itemExistente != null)
                    {
                        itemExistente.Cantidad += cant;
                        itemExistente.PrecioUnitario = precio; // Actualizamos por si hubo oferta
                    }
                    else
                    {
                        var nuevoDetalle = new DetalleVenta(prod, cant, 0) { PrecioUnitario = precio };
                        _carrito.Add(nuevoDetalle);
                    }

                    StateHasChanged();
                    Snackbar.Add($"{prod.Nombre} agregado.", Severity.Success);
                }

            } catch(Exception ex)
            {
                Console.WriteLine($"ERROR CRÍTICO AL LANZAR: {ex.Message}");
                Snackbar.Add("Error interno al abrir el diálogo", Severity.Error);
            }


            
        }
        else
        {
            Snackbar.Add($"Código {sku} no reconocido", Severity.Warning);
        }
    }

    // Método auxiliar para evitar duplicados y sumar cantidades
    private void AgregarDetalleAlCarrito(DetalleVenta nuevoDetalle)
    {
        var existente = _carrito.FirstOrDefault(x => x.Producto.Codigo == nuevoDetalle.Producto.Codigo);
        if (existente != null)
        {
            existente.Cantidad += nuevoDetalle.Cantidad;
            // Si el precio cambió por una oferta manual, actualizamos o promediamos
            existente.PrecioUnitario = nuevoDetalle.PrecioUnitario;
        }
        else
        {
            _carrito.Add(nuevoDetalle);
        }
    }

    private async Task ProcesarPago()
    {
        // 1. DIÁLOGO DE PAGO
        var parametersPago = new DialogParameters<PagoDialog> {
        { x => x.TotalVenta, _totalVenta }
    };

        var optionsStandard = new DialogOptions
        {
            CloseOnEscapeKey = true,
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            BackdropClick = false
        };

        var dialogPago = await DialogService.ShowAsync<PagoDialog>("Finalizar Venta", parametersPago, optionsStandard);
        var resultPago = await dialogPago.Result;

        // Si el usuario canceló el pago, nos detenemos aquí
        if (resultPago.Canceled || resultPago.Data == null) return;

        // --- AQUÍ ESTABA EL "HUECO" ---

        // 2. DIÁLOGO DE TRACKING (EL STEPPER)
        // Usamos opciones más estrictas para que no lo cierren por accidente
        var optionsTracking = new DialogOptions
        {
            CloseButton = false,
            BackdropClick = false,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialogTracking = await DialogService.ShowAsync<TrackingFacturacionDialog>("Estado de Emisión", optionsTracking);
        var resultTracking = await dialogTracking.Result;

        // Si el proceso de tracking terminó (Ok), mostramos el ticket
        if (!resultTracking.Canceled)
        {
            // 3. DIÁLOGO DE TICKET EXITOSO
            dynamic datos = resultPago.Data;

            var productosParaTicket = _carrito.Select(item => new TicketItemDto
            {
                Nombre = item.Producto.Nombre,
                Precio = item.PrecioUnitario,
                Cantidad = item.Cantidad
            }).ToList();

            await MostrarTicketExitoso(datos, productosParaTicket);

            // Limpieza final
            _carrito.Clear();
            Snackbar.Add("Venta registrada y declarada con éxito", Severity.Success);
            StateHasChanged();
        }
    }

    // CORREGIDO: Ahora el método acepta la lista de productos preparada
    private async Task MostrarTicketExitoso(dynamic datos, List<TicketItemDto> productos)
    {
        var parametersExito = new DialogParameters<VentaExitosaDialog>
        {
            { x => x.TotalPagado, (decimal)datos.TotalPagado },
            { x => x.Descuento, (decimal)datos.Descuento },
            { x => x.MetodoPago, (string)datos.Metodo },
            { x => x.ProductosVendidos, productos }, 
            { x => x.SerieNumero, $"B001-{DateTime.Now:mmssff}" } 
        };

        var options = new DialogOptions { CloseButton = false, MaxWidth = MaxWidth.Small, FullWidth = true };
        await DialogService.ShowAsync<VentaExitosaDialog>("Comprobante", parametersExito, options);
    }

}