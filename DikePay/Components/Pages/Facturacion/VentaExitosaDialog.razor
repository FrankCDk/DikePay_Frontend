@using MudBlazor
@using Microsoft.Maui.ApplicationModel @* Necesario para Browser.OpenAsync *@
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudStack AlignItems="AlignItems.Center" Spacing="2">

            @* Icono de éxito con animación sutil *@
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" Style="font-size: 4rem;" />
            <MudText Typo="Typo.h5" Color="Color.Success"><b>¡Cobro Exitoso!</b></MudText>

            @* Representación Visual de la Boleta (Estilo Ticket Térmico) *@
            <MudPaper Elevation="4" Class="pa-6 my-2"
                      Style="width: 300px; background-color: #fffdec; border: 1px solid #e0e0e0; font-family: 'Courier New', Courier, monospace; color: #333;">

                <MudStack AlignItems="AlignItems.Center" Spacing="0">
                    <MudText Typo="Typo.h6" Style="letter-spacing: 2px;"><b>DIKEPAY POS</b></MudText>
                    <MudText Typo="Typo.caption">RUC: 10456789012</MudText>
                    <MudText Typo="Typo.caption">Calle Los Emprendedores 123</MudText>
                    <MudText Typo="Typo.caption">Lima, Perú</MudText>
                    <MudText Typo="Typo.caption">--------------------------------</MudText>
                    <MudText Typo="Typo.body2"><b>BOLETA DE VENTA ELECTRÓNICA</b></MudText>
                    <MudText Typo="Typo.body2"><b>@SerieNumero</b></MudText>
                    <MudText Typo="Typo.caption">Fecha: @DateTime.Now.ToString("dd/MM/yyyy HH:mm")</MudText>
                    <MudText Typo="Typo.caption">--------------------------------</MudText>
                </MudStack>

                <div class="mt-4" style="min-height: 80px;">
                    @foreach (var item in ProductosVendidos)
                    {
                        <div class="d-flex justify-space-between mb-1">
                            <MudText Typo="Typo.caption" Style="max-width: 180px; overflow: hidden;">
                                @item.Cantidad x @item.Nombre
                            </MudText>
                            <MudText Typo="Typo.caption">S/ @((item.Precio * item.Cantidad).ToString("N2"))</MudText>
                        </div>
                    }
                </div>

                <MudStack Spacing="0" Class="mt-4">
                    <MudText Typo="Typo.caption">--------------------------------</MudText>

                    @if (Descuento > 0)
                    {
                        <div class="d-flex justify-space-between">
                            <MudText Typo="Typo.caption">DESCUENTO:</MudText>
                            <MudText Typo="Typo.caption">- S/ @Descuento.ToString("N2")</MudText>
                        </div>
                    }

                    <div class="d-flex justify-space-between">
                        <MudText Typo="Typo.body1"><b>TOTAL A PAGAR:</b></MudText>
                        <MudText Typo="Typo.body1"><b>S/ @TotalPagado.ToString("N2")</b></MudText>
                    </div>

                    <div class="d-flex justify-space-between mt-1">
                        <MudText Typo="Typo.caption">MÉTODO PAGO:</MudText>
                        <MudText Typo="Typo.caption">@MetodoPago</MudText>
                    </div>

                    <MudText Typo="Typo.caption">--------------------------------</MudText>
                    <MudText Typo="Typo.caption" Align="Align.Center" Class="mt-2">
                        Representación impresa de la boleta de venta.
                    </MudText>
                    <MudText Typo="Typo.body2" Align="Align.Center"><b>¡GRACIAS POR SU COMPRA!</b></MudText>
                </MudStack>
            </MudPaper>

            <MudText Typo="Typo.caption" Color="Color.Secondary">Envíe el comprobante digital al cliente</MudText>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       FullWidth="true"
                       StartIcon="@Icons.Custom.Brands.WhatsApp"
                       Size="Size.Large"
                       OnClick="CompartirWhatsApp"
                       Class="rounded-pill">
                ENVIAR POR WHATSAPP
            </MudButton>

        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cerrar"
                   Color="Color.Primary"
                   Variant="Variant.Text"
                   FullWidth="true">REALIZAR NUEVA VENTA</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;

    // Recibimos los datos de la venta como parámetros
    [Parameter] public string SerieNumero { get; set; } = "B001-000001";
    [Parameter] public decimal TotalPagado { get; set; }
    [Parameter] public decimal Descuento { get; set; }
    [Parameter] public string MetodoPago { get; set; } = "CONTADO";
    [Parameter] public List<dynamic> ProductosVendidos { get; set; } = new();
    // Nota: He usado 'dynamic' por si tu clase CarritoItem no está accesible aquí,
    // pero lo ideal es usar tu clase: List<CarritoItem>

    private void Cerrar() => MudDialog.Close(DialogResult.Ok(true));

    private async Task CompartirWhatsApp()
    {
        try
        {
            // Construcción del mensaje con formato WhatsApp
            string mensaje = $"*DIKEPAY - Comprobante Electrónico*%0A" +
                             $"---------------------------------%0A" +
                             $"*Boleta:* {SerieNumero}%0A" +
                             $"*Fecha:* {DateTime.Now:dd/MM/yyyy HH:mm}%0A" +
                             $"*Método:* {MetodoPago}%0A%0A" +
                             $"*Productos:*%0A";

            foreach (var item in ProductosVendidos)
            {
                mensaje += $"- {item.Cantidad} {item.Nombre} (S/ {item.Precio * item.Cantidad:N2})%0A";
            }

            if (Descuento > 0)
                mensaje += $"%0A*Descuento:* -S/ {Descuento:N2}";

            mensaje += $"%0A*TOTAL PAGADO: S/ {TotalPagado:N2}*%0A" +
                       $"---------------------------------%0A" +
                       $"Visualiza tu ticket aquí: [Link Opcional]%0A" +
                       $"¡Gracias por tu compra!";

            // Abrir WhatsApp usando el Launcher de MAUI
            var url = $"https://wa.me/?text={mensaje}";
            await Browser.Default.OpenAsync(url, BrowserLaunchMode.External);
        }
        catch (Exception ex)
        {
            Snackbar.Add("No se pudo abrir WhatsApp: " + ex.Message, Severity.Error);
        }
    }
}