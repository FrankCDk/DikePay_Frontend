@using MudBlazor
@using Microsoft.Maui.ApplicationModel
@using Microsoft.Maui.Storage
@using Microsoft.Maui.ApplicationModel.DataTransfer
@using DikePay.Application.Interfaces.Services
@using DikePay.Application.DTOs.Impresion
@inject ISnackbar Snackbar
@inject IPdfService PdfService

<MudDialog>
    <DialogContent>
        @* 1. max-height: 65vh limita el alto para que el diálogo no se pierda en la pantalla.
           2. overflow-y: auto permite el scroll vertical si el ticket es largo.
           3. overflow-x: hidden asegura que NADA se mueva hacia los lados.
        *@
        <div style="max-height: 65vh; overflow-y: auto; overflow-x: hidden; width: 100%;" class="px-2">
            
            @* Encabezado de Éxito Centrado *@
            <div class="d-flex flex-column align-center w-100 mb-4">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle"
                         Color="Color.Success"
                         Style="font-size: 5rem; display: block;"
                         Class="mx-auto" />

                <MudText Typo="Typo.h5"
                         Color="Color.Success"
                         Align="Align.Center"
                         Style="width: 100%;"
                         Class="mt-2">
                    <b>¡Cobro Exitoso!</b>
                </MudText>
            </div>

            <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="w-100">
                
                @* TICKET RESPONSIVO:
                   Cambiamos 'width: 320px' por 'max-width: 300px' para que en celulares 
                   pequeños se ajuste automáticamente y no genere scroll horizontal.
                *@
                <MudPaper Elevation="4" Class="pa-6 my-2"
                          Style="width: 100%; max-width: 300px; background-color: #fffdec; border: 1px dashed #bcbcbc; font-family: 'Courier New', Courier, monospace; color: #333; margin: 0 auto;">

                    <MudStack AlignItems="AlignItems.Center" Spacing="0" Style="width: 100%;">
                        <MudText Typo="Typo.h6" Align="Align.Center" Style="letter-spacing: 2px; width: 100%;"><b>DikePay POS</b></MudText>
                        <MudText Typo="Typo.caption" Align="Align.Center" Style="width: 100%;">RUC: 10456789012</MudText>
                        <MudText Typo="Typo.caption" Align="Align.Center" Style="width: 100%;">Calle Los Emprendedores 123</MudText>

                        <MudText Typo="Typo.caption" Align="Align.Center" Class="my-1">--------------------------------</MudText>

                        <MudText Typo="Typo.body2" Align="Align.Center" Style="width: 100%;"><b>BOLETA ELECTRÓNICA</b></MudText>
                        <MudText Typo="Typo.body2" Align="Align.Center" Style="width: 100%;"><b>@SerieNumero</b></MudText>
                        <MudText Typo="Typo.caption" Align="Align.Center" Style="width: 100%;">Fecha: @DateTime.Now.ToString("dd/MM/yyyy HH:mm")</MudText>

                        <MudText Typo="Typo.caption" Align="Align.Center" Class="my-1">--------------------------------</MudText>
                    </MudStack>

                    @* Detalle de Productos con manejo de texto largo *@
                    <div class="mt-4" style="min-height: 50px; width: 100%;">
                        @foreach (var item in ProductosVendidos)
                        {
                            <div class="d-flex justify-space-between mb-1" style="width: 100%;">
                                <MudText Typo="Typo.caption" Style="width: 65%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    @($"{item.Cantidad:N0} {item.Nombre}")
                                </MudText>
                                <MudText Typo="Typo.caption" Style="width: 35%; text-align: right; white-space: nowrap;">
                                    S/ @((item.Precio * item.Cantidad).ToString("N2"))
                                </MudText>
                            </div>
                        }
                    </div>

                    @* Totales *@
                    <MudStack Spacing="0" Class="mt-4" Style="width: 100%;">
                        <MudText Typo="Typo.caption" Align="Align.Center">--------------------------------</MudText>

                        @if (Descuento > 0)
                        {
                            <div class="d-flex justify-space-between w-100">
                                <MudText Typo="Typo.caption">DESCUENTO:</MudText>
                                <MudText Typo="Typo.caption">- S/ @Descuento.ToString("N2")</MudText>
                            </div>
                        }

                        <div class="d-flex justify-space-between py-1 w-100">
                            <MudText Typo="Typo.body1"><b>TOTAL PAGADO:</b></MudText>
                            <MudText Typo="Typo.body1"><b>S/ @TotalPagado.ToString("N2")</b></MudText>
                        </div>

                        <div class="mt-2 w-100">
                            <MudText Typo="Typo.caption" Style="text-decoration: underline;">FORMAS DE PAGO:</MudText>
                            @foreach (var p in PagosRealizados)
                            {
                                <div class="d-flex justify-space-between w-100">
                                    <MudText Typo="Typo.caption">@p.Metodo:</MudText>
                                    <MudText Typo="Typo.caption">S/ @p.Monto.ToString("N2")</MudText>
                                </div>
                            }
                        </div>

                        @if (Vuelto > 0)
                        {
                            <div class="d-flex justify-space-between mt-1 w-100">
                                <MudText Typo="Typo.caption">VUELTO:</MudText>
                                <MudText Typo="Typo.caption">S/ @Vuelto.ToString("N2")</MudText>
                            </div>
                        }

                        <MudText Typo="Typo.caption" Align="Align.Center" Class="mt-2">--------------------------------</MudText>
                        <MudText Typo="Typo.caption" Align="Align.Center" Class="mt-1" Style="width: 100%;">
                            Representación impresa de la boleta.
                        </MudText>
                        <MudText Typo="Typo.body2" Align="Align.Center" Style="width: 100%;" Class="mt-1"><b>¡GRACIAS POR SU COMPRA!</b></MudText>
                    </MudStack>
                </MudPaper>

                @* Botones de Acción Internos *@
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           StartIcon="@Icons.Material.Filled.Print"
                           Size="Size.Large"
                           OnClick="PrepararComprobanteYCompartir"
                           Class="rounded-pill mt-4 py-3">
                    IMPRIMIR / PDF
                </MudButton>

                <MudButton Variant="Variant.Outlined"
                           Color="Color.Success"
                           FullWidth="true"
                           StartIcon="@Icons.Custom.Brands.WhatsApp"
                           OnClick="CompartirSoloTexto"
                           Class="rounded-pill py-2">
                    WHATSAPP RÁPIDO
                </MudButton>
            </MudStack>
        </div>
    </DialogContent>

    <DialogActions>
        @* Contenedor con padding inferior extra (pb-8) para separar el botón 
           de los gestos de navegación de Android/iOS.
        *@
        <div class="w-100 px-6 pb-8">
            <MudButton OnClick="Cerrar"
                       Color="Color.Default"
                       Variant="Variant.Text"
                       FullWidth="true"
                       Size="Size.Large"
                       Class="py-3">
                NUEVA VENTA
            </MudButton>
        </div>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter] public string SerieNumero { get; set; } = "B001-000001";
    [Parameter] public decimal TotalPagado { get; set; } // Total Final del Ticket
    [Parameter] public decimal Descuento { get; set; }
    [Parameter] public decimal Vuelto { get; set; }
    [Parameter] public List<TicketItemDto> ProductosVendidos { get; set; } = new();

    // Cambiamos string MetodoPago por la lista de pagos para que cuadre con el resumen anterior
    [Parameter] public List<PagoDetalleDto> PagosRealizados { get; set; } = new();

    private void Cerrar() => MudDialog.Close(DialogResult.Ok(true));

    private async Task PrepararComprobanteYCompartir()
    {
        try
        {
            await PdfService.GenerarYImprimirAsync(SerieNumero, TotalPagado, ProductosVendidos);
        }
        catch (Exception)
        {
            await CompartirSoloTexto();
            Snackbar.Add("No se pudo abrir la impresora, enviando texto...", Severity.Info);
        }
    }

    private async Task CompartirSoloTexto()
    {
        string mensaje = $"*DIKEPAY - {SerieNumero}*%0A" +
                         $"*Total: S/ {TotalPagado:N2}*%0A" +
                         $"¡Gracias por su compra!";

        var url = $"https://wa.me/?text={mensaje}";
        await Browser.Default.OpenAsync(url, BrowserLaunchMode.External);
    }

    // DTOs locales si no los tienes globales
    public class PagoDetalleDto { public string Metodo { get; set; } = ""; public decimal Monto { get; set; } }
}