@using MudBlazor
@using Microsoft.Maui.ApplicationModel @* Necesario para Browser.OpenAsync *@
@using Microsoft.Maui.Storage @* Para FileSystem *@
@using Microsoft.Maui.ApplicationModel.DataTransfer @* Para Share *@
@using DikePay.Application.Interfaces.Services
@inject ISnackbar Snackbar
@inject IPdfService PdfService

<MudDialog>
    <DialogContent>
        <MudStack AlignItems="AlignItems.Center" Spacing="2">

            @* Icono de éxito con animación sutil *@
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" Style="font-size: 4rem;" />
            <MudText Typo="Typo.h5" Color="Color.Success"><b>¡Cobro Exitoso!</b></MudText>

            @* Representación Visual de la Boleta (Estilo Ticket Térmico) *@
            <MudPaper Elevation="4" Class="pa-6 my-2"
                      Style="width: 300px; background-color: #fffdec; border: 1px solid #e0e0e0; font-family: 'Courier New', Courier, monospace; color: #333;">

                <MudStack AlignItems="AlignItems.Center" Spacing="0">
                    <MudText Typo="Typo.h6" Style="letter-spacing: 2px;"><b>DIKEPAY POS</b></MudText>
                    <MudText Typo="Typo.caption">RUC: 10456789012</MudText>
                    <MudText Typo="Typo.caption">Calle Los Emprendedores 123</MudText>
                    <MudText Typo="Typo.caption">Lima, Perú</MudText>
                    <MudText Typo="Typo.caption">--------------------------------</MudText>
                    <MudText Typo="Typo.body2"><b>BOLETA DE VENTA ELECTRÓNICA</b></MudText>
                    <MudText Typo="Typo.body2"><b>@SerieNumero</b></MudText>
                    <MudText Typo="Typo.caption">Fecha: @DateTime.Now.ToString("dd/MM/yyyy HH:mm")</MudText>
                    <MudText Typo="Typo.caption">--------------------------------</MudText>
                </MudStack>

                <div class="mt-4" style="min-height: 80px;">
                    @foreach (var item in ProductosVendidos)
                    {
                        <div class="d-flex justify-space-between mb-1">
                            <MudText Typo="Typo.caption" Style="max-width: 180px; overflow: hidden;">
                                @item.Cantidad x @item.Nombre
                            </MudText>
                            <MudText Typo="Typo.caption">S/ @((item.Precio * item.Cantidad).ToString("N2"))</MudText>
                        </div>
                    }
                </div>

                <MudStack Spacing="0" Class="mt-4">
                    <MudText Typo="Typo.caption">--------------------------------</MudText>

                    @if (Descuento > 0)
                    {
                        <div class="d-flex justify-space-between">
                            <MudText Typo="Typo.caption">DESCUENTO:</MudText>
                            <MudText Typo="Typo.caption">- S/ @Descuento.ToString("N2")</MudText>
                        </div>
                    }

                    <div class="d-flex justify-space-between">
                        <MudText Typo="Typo.body1"><b>TOTAL A PAGAR:</b></MudText>
                        <MudText Typo="Typo.body1"><b>S/ @TotalPagado.ToString("N2")</b></MudText>
                    </div>

                    <div class="d-flex justify-space-between mt-1">
                        <MudText Typo="Typo.caption">MÉTODO PAGO:</MudText>
                        <MudText Typo="Typo.caption">@MetodoPago</MudText>
                    </div>

                    <MudText Typo="Typo.caption">--------------------------------</MudText>
                    <MudText Typo="Typo.caption" Align="Align.Center" Class="mt-2">
                        Representación impresa de la boleta de venta.
                    </MudText>
                    <MudText Typo="Typo.body2" Align="Align.Center"><b>¡GRACIAS POR SU COMPRA!</b></MudText>
                </MudStack>
            </MudPaper>

            <MudText Typo="Typo.caption" Color="Color.Secondary">Envíe el comprobante digital al cliente</MudText>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       StartIcon="@Icons.Material.Filled.Print"
                       Size="Size.Large"
                       OnClick="PrepararComprobanteYCompartir"
                       Class="rounded-pill mb-2">
                IMPRIMIR / GENERAR PDF
            </MudButton>

            @* Botón Secundario: Texto plano (El que sí abre WhatsApp directo) *@
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Success"
                       FullWidth="true"
                       StartIcon="@Icons.Custom.Brands.WhatsApp"
                       Size="Size.Medium"
                       OnClick="CompartirSoloTexto"
                       Class="rounded-pill">
                ENVIAR RESUMEN POR WHATSAPP
            </MudButton>

        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cerrar"
                   Color="Color.Primary"
                   Variant="Variant.Text"
                   FullWidth="true">REALIZAR NUEVA VENTA</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter] public string SerieNumero { get; set; } = "B001-000001";
    [Parameter] public decimal TotalPagado { get; set; }
    [Parameter] public decimal Descuento { get; set; }
    [Parameter] public string MetodoPago { get; set; } = "CONTADO";
    [Parameter] public List<dynamic> ProductosVendidos { get; set; } = new();

    private void Cerrar() => MudDialog.Close(DialogResult.Ok(true));

    // Cambiamos el nombre para que sea honesto con lo que hace
    private async Task PrepararComprobanteYCompartir()
    {
        try
        {
            await PdfService.GenerarYImprimirAsync(SerieNumero, TotalPagado, ProductosVendidos);
            Snackbar.Add("Seleccione 'Guardar como PDF' para enviar por WhatsApp", Severity.Info);
        }
        catch (Exception ex)
        {
            // FALLBACK: Si falla la impresión, enviamos el texto plano para no dejar al usuario colgado
            await CompartirSoloTexto();
            Snackbar.Add("Enviando como texto plano...", Severity.Info);
        }
    }

    private async Task CompartirSoloTexto()
    {
        string mensaje = $"*DIKEPAY - {SerieNumero}*%0A" +
                         $"*Total: S/ {TotalPagado:N2}*%0A" +
                         $"¡Gracias por su compra!";

        var url = $"https://wa.me/?text={mensaje}";
        await Browser.Default.OpenAsync(url, BrowserLaunchMode.External);
    }

}