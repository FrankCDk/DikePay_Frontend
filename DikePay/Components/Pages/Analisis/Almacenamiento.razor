@page "/almacenamiento"
@using DikePay.Services.Interfaces
@inject IAlmacenamientoService DbService
@using MudBlazor

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudText Typo="Typo.h5" GutterBottom="true">Estado del Sistema</MudText>
    <MudText Typo="Typo.body2" Class="mb-6">Monitorea tu consumo de recursos y límites de tu plan actual.</MudText>

    <MudGrid>
        @* Card de Comprobantes *@
        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-4">
                <div class="d-flex align-center mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Description" Color="Color.Primary" Class="mr-2" />
                    <MudText Typo="Typo.h6">Comprobantes</MudText>
                </div>

                <div class="d-flex justify-space-between mb-1">
                    <MudText Typo="Typo.body2">Límite de emisión</MudText>
                    <MudText Typo="Typo.body2"><b>@conteoActual / @LimiteMaximo</b></MudText>
                </div>

                <MudProgressLinear Color="@GetColor(conteoActual, LimiteMaximo)"
                                   Value="@porcentajeComprobantes"
                                   Size="Size.Large"
                                   Class="my-3 rounded-lg" />

                <MudText Typo="Typo.caption">
                    @(LimiteMaximo - conteoActual) comprobantes restantes disponibles.
                </MudText>
            </MudPaper>
        </MudItem>

        @* Card de Base de Datos (Opcional pero muy Pro) *@
        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-4" Style="border-left: 4px solid var(--mud-palette-secondary);">
                <div class="d-flex align-center mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.SdStorage" Color="Color.Secondary" Class="mr-2" />
                    <MudText Typo="Typo.h6">Memoria Local</MudText>
                </div>
                <MudText Typo="Typo.body2">Espacio ocupado en disco:</MudText>
                <MudText Typo="Typo.h5"><b>@tamañoDbMB MB</b></MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private int conteoActual = 0;
    private int LimiteMaximo = 500;
    private double porcentajeComprobantes => (double)conteoActual / LimiteMaximo * 100;
    private string tamañoDbMB = "0.00";

    protected override async Task OnInitializedAsync()
    {
        conteoActual = await DbService.ObtenerConteoComprobantesAsync();

        // Bonus Senior: Obtener el tamaño real del archivo .db3
        try {

            tamañoDbMB = await DbService.ObtenerTamañoArchivoDb();

        } catch
        {
            tamañoDbMB = "0.00";
        }
    }

    private Color GetColor(int actual, int max)
    {
        double p = (double)actual / max * 100;
        if (p >= 90) return Color.Error;
        if (p >= 70) return Color.Warning;
        return Color.Success;
    }
}