@using MudBlazor
@page "/configuracion/articulos"
@using DikePay.Domain.Entities
@using DikePay.Application.DTOs.Articulos.Request
@using DikePay.Application.Interfaces.Services
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IArticuloService ArticuloService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
        <MudText Typo="Typo.h4" Color="Color.Primary"><b>FacwebApp</b> - Maestro de Artículos</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="CrearNuevoArticulo">
            Nuevo Artículo
        </MudButton>
    </MudStack>

    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="5">
                <MudTextField @bind-Value="_filtroCodigo" Label="Filtrar por Código" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Clearable OnClear="RefrescarTabla" />
            </MudItem>
            <MudItem xs="12" sm="5">
                <MudTextField @bind-Value="_filtroNombre" Label="Filtrar por Nombre" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Clearable OnClear="RefrescarTabla" />
            </MudItem>
            <MudItem xs="12" sm="2" Class="d-flex align-center">
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" FullWidth OnClick="RefrescarTabla">Buscar</MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudTable T="Articulo" ServerData="@CargarArticulos" @ref="_table" Hover="true" Bordered="true" Striped="true" Elevation="1">
        <HeaderContent>
            <MudTh>CÓDIGO</MudTh>
            <MudTh>NOMBRE</MudTh>
            <MudTh>PRECIO</MudTh>
            <MudTh>SKU</MudTh>
            <MudTh>STOCK</MudTh>
            <MudTh Style="text-align: right;">ACCIONES</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Codigo">@context.Codigo</MudTd>
            <MudTd DataLabel="Nombre">@context.Nombre</MudTd>
            <MudTd DataLabel="Precio" Style="text-align: right;">@context.Precio.ToString("C2")</MudTd>
            <MudTd DataLabel="SKU">@context.CodigoSku</MudTd>
            <MudTd DataLabel="Stock">@context.Stock</MudTd>
            <MudTd Style="text-align: center;">
                <MudIconButton Icon="@Icons.Material.Outlined.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditarArticulo(context))" />
                <MudIconButton Icon="@Icons.Material.Outlined.QrCode" Color="Color.Info" Size="Size.Small" OnClick="@(() => MostrarBarcode(context))" Disabled="@(string.IsNullOrEmpty(context.CodigoSku))" />
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No se encontraron artículos con los filtros aplicados.</MudText>
        </NoRecordsContent>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 10, 25, 50 }" RowsPerPageString="Registros por página:" />
        </PagerContent>
    </MudTable>
</MudContainer>

@code {
    private MudTable<Articulo> _table;
    private string _filtroCodigo = string.Empty;
    private string _filtroNombre = string.Empty;

    // Esta función es el "corazón" de la tabla paginada
    private async Task<TableData<Articulo>> CargarArticulos(TableState state, CancellationToken token)
    {
        // El state nos dice en qué página está el usuario y cuántos registros quiere (Skip/Take)
        // Convertimos el index de MudBlazor (0-based) a nuestra lógica de página (1-based)
        var response = await ArticuloService.ListarArticulosAsync(_filtroCodigo, _filtroNombre, state.Page + 1, state.PageSize);

        return new TableData<Articulo>()
        {
            TotalItems = response.TotalRegistros,
            Items = response.Items
        };
    }

    private Task RefrescarTabla() => _table.ReloadServerData();

    private async Task CrearNuevoArticulo()
    {
        var nuevoArticulo = new ArticuloCreateDto();
        var parameters = new DialogParameters { ["Articulo"] = nuevoArticulo };

        var dialog = await DialogService.ShowAsync<ArticuloFormDialog>("Nuevo Artículo", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is ArticuloCreateDto articuloAGuardar)
        {
            var exito = await ArticuloService.CrearArticuloAsync(articuloAGuardar);
            if (exito)
            {
                Snackbar.Add("Artículo creado con éxito!", Severity.Success);
                await RefrescarTabla();
            }
            else
            {
                Snackbar.Add("Error al guardar el artículo.", Severity.Error);
            }
        }
    }

    private async Task EditarArticulo(Articulo articulo)
    {
        // Tip Senior: Pasa una copia del objeto al diálogo para evitar que la UI
        // se actualice si el usuario cancela (si usas Binding directo)

        ArticuloCreateDto editArticulo = new ArticuloCreateDto
        {
            Codigo = articulo.Codigo,
            CodigoSku = articulo.CodigoSku,
            Nombre = articulo.Nombre,
            //Descripcion = articulo.Descripcion,
            Precio = articulo.Precio,
            Stock = articulo.Stock,
            StockMinimo = articulo.StockMinimo
        };

        var parameters = new DialogParameters { ["Articulo"] = editArticulo };
        var dialog = await DialogService.ShowAsync<ArticuloFormDialog>("Editar Artículo", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var exito = await ArticuloService.ActualizarArticuloAsync(editArticulo);
            if (exito)
            {
                Snackbar.Add("Artículo actualizado!", Severity.Success);
                await RefrescarTabla();
            }
        }
    }

    private async Task MostrarBarcode(Articulo articulo)
    {
        if (string.IsNullOrEmpty(articulo.CodigoSku))
        {
            Snackbar.Add("Este artículo no tiene un Código SKU asignado.", Severity.Warning);
            return;
        }

        var parameters = new DialogParameters { ["CodigoSku"] = articulo.CodigoSku };
        await DialogService.ShowAsync<BarcodeDisplayDialog>($"Código de Barras: {articulo.Nombre}", parameters);
    }
}