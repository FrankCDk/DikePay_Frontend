@using DikePay.Domain.Entities
@using MudBlazor
@inject MudBlazor.IDialogService DialogService
@inject MudBlazor.ISnackbar Snackbar
@namespace DikePay.Components.Shared

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">@_dialogTitle</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm Model="@Articulo" @ref="_form">
            <MudTextField @bind-Value="Articulo.Nombre" Label="Nombre del Artículo" Required="true" RequiredError="El nombre es requerido." />
            <MudNumericField @bind-Value="Articulo.Precio" Label="Precio" Required="true" RequiredError="El precio es requerido." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AttachMoney" Culture='System.Globalization.CultureInfo.GetCultureInfo("es-PE")' />
            <MudNumericField @bind-Value="Articulo.Stock" Label="Stock Inicial" Required="true" RequiredError="El stock es requerido." />
            <MudTextField @bind-Value="Articulo.CodigoSku" Label="Código SKU" HelperText="Dejar vacío para generar automáticamente" />

            @if (!string.IsNullOrEmpty(Articulo.CodigoSku))
            {
                <MudButton Class="mt-4" StartIcon="@Icons.Material.Filled.QrCode" Color="Color.Info" Variant="Variant.Text" OnClick="ShowBarcodePreview">
                    Ver Código de Barras
                </MudButton>
            }
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancelar</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Variant="Variant.Filled">Guardar</MudButton>
    </DialogActions>
</MudDialog>

@code {
    
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    // El artículo que estamos editando/creando
    [Parameter] public Articulo Articulo { get; set; } = new();

    private MudForm _form = default!;
    private string _dialogTitle = "Artículo";

    protected override void OnInitialized()
    {
        _dialogTitle = Articulo.Codigo == "" ? "Nuevo Artículo" : $"Editar Artículo (CODIGO: {Articulo.Codigo})";
        // Si es un nuevo artículo y el SKU está vacío, lo generamos automáticamente
        if (Articulo.Codigo == "" && string.IsNullOrEmpty(Articulo.CodigoSku))
        {
            // Esto es solo un ejemplo. En un sistema real, harías una llamada a la API
            // o a un servicio para obtener el siguiente ID y construir un SKU único.
            // Por ahora, lo dejamos vacío para que el usuario pueda escribirlo.
            // Si el usuario deja vacío, lo generamos al guardar si no lo puso.
        }
    }

    private async Task Submit()
    {
        await _form.Validate();
        if (_form.IsValid)
        {
            // Aquí podrías generar el SKU si el usuario no lo puso
            if (string.IsNullOrEmpty(Articulo.CodigoSku))
            {
                Articulo.CodigoSku = $"SKU-{Guid.NewGuid().ToString().Substring(0, 8).ToUpper()}";
            }
            MudDialog.Close(DialogResult.Ok(Articulo));
        }
        else
        {
            Snackbar.Add("Por favor, corrige los errores del formulario.", Severity.Error);
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task ShowBarcodePreview()
    {
        if (!string.IsNullOrEmpty(Articulo.CodigoSku))
        {
            var parameters = new DialogParameters { ["CodigoSku"] = Articulo.CodigoSku };
            await DialogService.ShowAsync<DikePay.Components.Shared.BarcodeDisplayDialog>($"Código de Barras para {Articulo.Nombre}", parameters);
        }
        else
        {
            Snackbar.Add("El artículo no tiene un Código SKU para mostrar.", Severity.Warning);
        }
    }
}