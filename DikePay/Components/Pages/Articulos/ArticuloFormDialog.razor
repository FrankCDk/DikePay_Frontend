@using System.ComponentModel.DataAnnotations
@using DikePay.Application.DTOs.Articulos.Request
@using MudBlazor
@using MudBlazor.Components
@inject MudBlazor.IDialogService DialogService
@inject MudBlazor.ISnackbar Snackbar
@namespace DikePay.Components.Pages.Articulos

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Inventory" Class="mr-2 mb-n1" />
            @_dialogTitle
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm Model="@Articulo" @ref="_form">
            <MudGrid Spacing="2">
                @* Sección de Identificación *@
                <MudItem xs="12" sm="6">
                    <MudTextField T="string"
                                  Label="Código Interno"
                                  Variant="Variant.Outlined"
                                  @bind-Value="Articulo.Codigo"
                                  For="@(() => Articulo.Codigo)"
                                  Placeholder="EJ: ART-001"
                                  Immediate="true" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField T="string"
                                  Label="Código SKU"
                                  Variant="Variant.Outlined"
                                  @bind-Value="Articulo.CodigoSku"
                                  For="@(() => Articulo.CodigoSku)"
                                  ReadOnly="@(!string.IsNullOrEmpty(Articulo.CodigoSku) && _dialogTitle.Contains("Editar"))"
                                  HelperText="Código de barras único"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@Icons.Material.Filled.QrCode"
                                  OnAdornmentClick="ShowBarcodePreview" />
                </MudItem>

                @* Información General *@
                <MudItem xs="12">
                    <MudTextField T="string"
                                  Label="Nombre del Producto"
                                  Variant="Variant.Outlined"
                                  @bind-Value="Articulo.Nombre"
                                  For="@(() => Articulo.Nombre)"
                                  Counter="200"
                                  MaxLength="200"
                                  Immediate="true" />
                </MudItem>

                @* Precios y Stock (Usamos NumericField para mejor UX en móviles) *@
                <MudItem xs="12" sm="4">
                    <MudNumericField T="decimal"
                                     Label="Precio de Venta"
                                     Variant="Variant.Outlined"
                                     @bind-Value="Articulo.Precio"
                                     For="@(() => Articulo.Precio)"
                                     Format="N2"
                                     Culture="@_enUs"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Filled.AttachMoney" />
                </MudItem>

                <MudItem xs="12" sm="4">
                    <MudNumericField T="decimal"
                                     Label="Stock Inicial"
                                     Variant="Variant.Outlined"
                                     @bind-Value="Articulo.Stock"
                                     For="@(() => Articulo.Stock)"
                                     Format="N4"
                                     Culture="@_enUs"
                                     HelperText="Cantidad actual" />
                </MudItem>

                <MudItem xs="12" sm="4">
                    <MudNumericField T="decimal"
                                     Label="Stock Mínimo"
                                     Variant="Variant.Outlined"
                                     @bind-Value="Articulo.StockMinimo"
                                     For="@(() => Articulo.StockMinimo)"
                                     Format="N4"
                                     Culture="@_enUs"
                                     HelperText="Alerta de reposición" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text" Class="px-6">Cancelar</MudButton>
        <MudButton Color="Color.Primary"
                   OnClick="Submit"
                   Variant="Variant.Filled"
                   Class="px-10 rounded-pill">Guardar Artículo</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public ArticuloCreateDto Articulo { get; set; } = new();

    private MudForm _form = default!;
    private string _dialogTitle = "Artículo";

    // Configuramos una cultura para asegurar que el punto sea decimal
    private System.Globalization.CultureInfo _enUs = System.Globalization.CultureInfo.GetCultureInfo("en-US");

    protected override void OnInitialized()
    {
        _dialogTitle = string.IsNullOrWhiteSpace(Articulo.Codigo) ? "Nuevo Artículo" : $"Editar Artículo";
    }

    private async Task Submit()
    {
        await _form.Validate();
        if (_form.IsValid)
        {
            // Lógica Senior: Si el SKU es obligatorio en el DTO pero lo generamos nosotros,
            // debemos asegurarnos de que tenga valor ANTES de que el servicio lo procese.
            if (string.IsNullOrWhiteSpace(Articulo.CodigoSku))
            {
                Articulo.CodigoSku = $"SKU-{Guid.NewGuid().ToString()[..8].ToUpper()}";
            }

            MudDialog.Close(DialogResult.Ok(Articulo));
        }
        else
        {
            Snackbar.Add("Revisa los campos obligatorios marcados en rojo.", Severity.Warning);
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task ShowBarcodePreview()
    {
        if (!string.IsNullOrEmpty(Articulo.CodigoSku))
        {
            var parameters = new DialogParameters { ["CodigoSku"] = Articulo.CodigoSku };
            await DialogService.ShowAsync<DikePay.Components.Shared.BarcodeDisplayDialog>($"Código: {Articulo.CodigoSku}", parameters);
        }
        else
        {
            Snackbar.Add("Asigna un código SKU para visualizar el código de barras.", Severity.Info);
        }
    }
}