@using MudBlazor
@page "/configuracion/acceso"
@using DikePay.Application.Interfaces.Maui
@using DikePay.Application.Interfaces.Services
@inject IQrService QrService
@inject IAuthService AuthService
@inject ISnackbar Snackbar

<MudText Typo="Typo.h5">Acceso Dispositivo Móvil</MudText>
<MudPaper Class="pa-4 mt-4" Elevation="2">
    <MudStack AlignItems="AlignItems.Center">
        <MudText>Escanea este código desde otro celular para iniciar sesión instantáneamente.</MudText>
        
        @if (string.IsNullOrEmpty(_qrSvg))
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="GenerarTokenAcceso">
                Generar Código de Acceso
            </MudButton>
        }
        else
        {
            <div style="width: 250px; background: white; padding: 15px; border-radius: 8px;">
                @((MarkupString)_qrSvg)
            </div>
            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mt-2">
                Este código expira en 5 minutos.
            </MudAlert>
        }
    </MudStack>
</MudPaper>

@code {
    private string _qrSvg;
    private bool _isGenerating;

    private async Task GenerarTokenAcceso()
    {
        _isGenerating = true;
        try 
        {
            // SENIOR TIP: Nunca generes el secreto en el cliente.
            // Llamamos a la API para que ella decida qué código usar.
            var response = await AuthService.GenerateMobileAccessCodeAsync(); 
            
            if (response.Success) 
            {
                // El QR ahora solo contiene un TOKEN aleatorio, NO la clave
                _qrSvg = QrService.GenerarQrBase64(response.Data); 
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("No se pudo generar el código: " + ex.Message, Severity.Error);
        }
        finally { _isGenerating = false; }
    }
}